<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å˜å‹å™¨ç»§ä¿å®šå€¼è®¡ç®—å™¨ v6.0</title>
  <style>
    /* CSS å˜é‡å®šä¹‰ - ç°ä»£åŒ–é…è‰²æ–¹æ¡ˆ */
    :root {
      --primary-color: #5B5FDE;
      --primary-hover: #4A4ECC;
      --primary-light: #E8E9FF;
      --secondary-color: #6C757D;
      --success-color: #10B981;
      --success-light: #D1FAE5;
      --danger-color: #EF4444;
      --danger-light: #FEE2E2;
      --warning-color: #F59E0B;
      --warning-light: #FEF3C7;
      --info-color: #3B82F6;
      --info-light: #DBEAFE;
      
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: #FFFFFF;
      --bg-color: #F8F9FB;
      --border-color: #E5E7EB;
      --text-color: #1F2937;
      --text-secondary: #6B7280;
      --text-light: #9CA3AF;
      
      --radius-sm: 6px;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* æš—è‰²ä¸»é¢˜ */
    @media (prefers-color-scheme: dark) {
      :root {
        --card-bg: #1F2937;
        --bg-color: #111827;
        --border-color: #374151;
        --text-color: #F9FAFB;
        --text-secondary: #D1D5DB;
        --text-light: #9CA3AF;
        --primary-light: #312E81;
        --success-light: #064E3B;
        --danger-light: #7F1D1D;
        --warning-light: #78350F;
        --info-light: #1E3A8A;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* èƒŒæ™¯è£…é¥° */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 300px;
      background: var(--bg-gradient);
      z-index: -1;
      opacity: 0.1;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* å¤´éƒ¨è®¾è®¡ */
    .header {
      text-align: center;
      padding: 40px 20px;
      margin-bottom: 40px;
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: var(--bg-gradient);
      border-radius: 2px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version-info {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-top: 10px;
    }

    .version-info p {
      margin: 5px 0;
    }

    /* æ ‡ç­¾é¡µè®¾è®¡ */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 8px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .tab {
      flex: 1;
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--primary-color);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      opacity: 0.1;
    }

    .tab:hover {
      color: var(--primary-color);
      background: var(--primary-light);
    }

    .tab:hover::before {
      width: 100%;
      height: 100%;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å¡ç‰‡è®¾è®¡ */
    .section {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .section:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-color);
    }

    .section-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-light);
      border-radius: var(--radius);
      font-size: 1.25rem;
    }

    /* è¾“å…¥ç»„è®¾è®¡ */
    .input-group {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    label {
      min-width: 150px;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input, select {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.875rem;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(91, 95, 222, 0.1);
    }

    input[readonly] {
      background-color: var(--bg-color);
      cursor: not-allowed;
      opacity: 0.7;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-family: 'Consolas', 'Monaco', monospace;
      resize: vertical;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(91, 95, 222, 0.1);
    }

    /* æŒ‰é’®è®¾è®¡ */
    .button-group {
      display: flex;
      gap: 12px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #DC2626;
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #4B5563;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background: #D97706;
    }

    /* å®¹é‡é€‰æ‹©å™¨è®¾è®¡ */
    .capacity-container {
      margin: 25px 0;
      padding: 20px;
      background: var(--bg-color);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }

    .capacity-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .capacity-count {
      padding: 8px 16px;
      background: var(--primary-light);
      color: var(--primary-color);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    #selectedList {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #selectedList > div {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--info-light);
      color: var(--info-color);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #selectedList button {
      margin-left: 8px;
      background: none;
      border: none;
      color: var(--info-color);
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }

    #selectedList button:hover {
      background: var(--info-color);
      color: white;
      transform: scale(1.1);
    }

    /* ç»“æœæ˜¾ç¤ºè®¾è®¡ */
    .results {
      margin-top: 30px;
      padding: 30px;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--card-bg) 100%);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .result-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .result-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .result-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .primary-value {
      color: var(--danger-color);
    }

    .text-result {
      padding: 20px;
      background: var(--info-light);
      border-left: 4px solid var(--info-color);
      border-radius: var(--radius);
      font-size: 1rem;
      line-height: 1.8;
      margin-top: 20px;
    }

    /* æ¶ˆæ¯æç¤ºè®¾è®¡ */
    .warning-message, .error-message, .success-message {
      margin-top: 20px;
      padding: 16px 20px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .warning-message {
      background: var(--warning-light);
      color: var(--warning-color);
      border: 1px solid var(--warning-color);
    }

    .error-message {
      background: var(--danger-light);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }

    .success-message {
      background: var(--success-light);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }

    /* æ‰¹é‡é¢„è§ˆè®¾è®¡ */
    .batch-preview {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      padding: 15px;
      background: var(--bg-color);
    }

    .batch-item {
      padding: 15px;
      margin-bottom: 12px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .batch-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    .batch-item.error {
      border-color: var(--danger-color);
      background: var(--danger-light);
    }

    .batch-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .batch-item-details {
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    /* ç»Ÿè®¡ä¿¡æ¯è®¾è®¡ */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .stat-item {
      text-align: center;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .stat-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* å·¥å…·æç¤º */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background: var(--text-color);
      color: var(--card-bg);
      text-align: center;
      border-radius: var(--radius);
      padding: 8px 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
      box-shadow: var(--shadow-lg);
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--text-color) transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* æ–‡å­—å¤„ç†ç»“æœ */
    .text-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .text-result-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .text-result-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    .text-result-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .text-result-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    /* æ¨¡æ€æ¡†è®¾è®¡ */
    #capacityModal {
      backdrop-filter: blur(5px);
    }

    #capacityModal > div {
      background: var(--card-bg);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translate(-50%, -45%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    #capacityOptions > div {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    #capacityOptions button {
      padding: 12px;
      font-size: 0.875rem;
    }

    /* æ‰¹é‡ç»“æœè®¾è®¡ */
    .batch-result-item {
      margin-bottom: 25px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .batch-result-item:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .batch-result-header {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .batch-result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        width: 100%;
      }
      
      .input-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      label {
        width: 100%;
      }
      
      input, select {
        width: 100%;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
      
      .result-grid {
        grid-template-columns: 1fr;
      }
    }

    /* æ‰“å°æ ·å¼ */
    @media print {
      body {
        background: white;
      }
      
      body::before {
        display: none;
      }
      
      .button-group, .tabs {
        display: none;
      }
      
      .section {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å˜å‹å™¨ç»§ä¿å®šå€¼è®¡ç®—å™¨</h1>
      <div class="version-info">
        <p>ç‰ˆæœ¬ 6.0 | 250702 | æ ¸å¿ƒé‡æ„ï¼Œå…¨æ–°UIè®¾è®¡</p>
        <p>å¼€å‘è€…ï¼šéŸ©ç¿° | åé¦ˆé‚®ç®±ï¼šicevivi8@gmail.com</p>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('single', this)">
        <span>âš¡ å•ä¸ªè®¡ç®—</span>
      </button>
      <button class="tab" onclick="switchTab('batch', this)">
        <span>ğŸ“Š æ‰¹é‡è®¡ç®—</span>
      </button>
      <button class="tab" onclick="switchTab('text', this)">
        <span>ğŸ“ æ–‡å­—å¤„ç†</span>
      </button>
    </div>

    <!-- å•ä¸ªè®¡ç®—æ ‡ç­¾é¡µ -->
    <div id="single-tab" class="tab-content active">
      <div class="section">
        <h2>
          <span class="section-icon">âš¡</span>
          å˜å‹å™¨å®šå€¼è®¡ç®—
        </h2>
        
        <!-- åŸºæœ¬å‚æ•°è®¾ç½® -->
        <div class="parameters-group">
          <div class="input-group">
            <label>ğŸ·ï¸ å¼€å…³åç§°</label>
            <input type="text" id="switchName" placeholder="è¯·è¾“å…¥å¼€å…³åç§°">
          </div>
          <div class="input-group">
            <label>ğŸ”„ ç›¸åºå˜æ¯”</label>
            <input type="text" id="k3" value="600/5" placeholder="ä¾‹å¦‚ï¼š600/5">
            <span class="tooltip">â“
              <span class="tooltiptext">ç›¸åºCTå˜æ¯”ï¼Œæ ¼å¼ï¼šXX/5</span>
            </span>
          </div>
          <div class="input-group">
            <label>â­• é›¶åºå˜æ¯”</label>
            <input type="text" id="k0" value="100/5" placeholder="ä¾‹å¦‚ï¼š100/5">
            <span class="tooltip">â“
              <span class="tooltiptext">é›¶åºCTå˜æ¯”ï¼Œæ ¼å¼ï¼šXX/5</span>
            </span>
          </div>
          <div class="input-group">
            <label>ğŸ“Š ç«™å‡ºçº¿CTè§„æ ¼</label>
            <select id="ctOption">
              <option value="no" selected>æ ‡å‡†</option>
              <option value="yes">600A (å˜ç”µç«™)</option>
            </select>
          </div>
        </div>
        
        <!-- å®¹é‡é€‰æ‹©åŒºåŸŸ -->
        <div class="capacity-container">
          <div class="capacity-controls">
            <button class="btn-secondary" onclick="showCapacitySelector()">
              â• æ·»åŠ å®¹é‡
            </button>
            <span class="capacity-count" id="capacityCount">å·²é€‰æ‹© 0 ä¸ªå®¹é‡</span>
          </div>
          <div id="selectedCapacities" style="display: none;">
            <h3 style="font-size: 1rem; margin-bottom: 15px; color: var(--text-secondary);">å·²é€‰å®¹é‡åˆ—è¡¨ï¼š</h3>
            <div id="selectedList"></div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="button-group">
          <button class="btn-primary" onclick="calculate()">
            ğŸ“Š è®¡ç®—å˜å‹å™¨å®šå€¼
          </button>
          <button class="btn-danger" onclick="resetCapacities()">
            ğŸ—‘ï¸ æ¸…ç©ºå·²é€‰å®¹é‡
          </button>
          <button class="btn-secondary" onclick="exportResults()">
            ğŸ“¥ å¯¼å‡ºç»“æœ
          </button>
        </div>

        <!-- è®¡ç®—ç»“æœæ˜¾ç¤º -->
        <div class="results" id="results" style="display: none">
          <h3 style="margin-top: 0; color: var(--primary-color);">è®¡ç®—ç»“æœ</h3>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">è´Ÿè·ç”µæµ</div>
              <div class="result-value" id="loadCurrent">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">ä¸€æ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰</div>
              <div class="result-value" id="firstProtection">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">äºŒæ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰</div>
              <div class="result-value" id="secondProtection">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">ä¸€æ®µå®šå€¼ï¼ˆä¸€æ¬¡å€¼ï¼‰</div>
              <div class="result-value primary-value" id="firstProtectionPrimary">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">äºŒæ®µå®šå€¼ï¼ˆä¸€æ¬¡å€¼ï¼‰</div>
              <div class="result-value primary-value" id="secondProtectionPrimary">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">é›¶åºå®šå€¼</div>
              <div class="result-value" id="zeroSequence">-</div>
            </div>
          </div>
          <div class="text-result" id="textResult"></div>
          <div id="warningContainer"></div>
        </div>
      </div>
    </div>

    <!-- æ‰¹é‡è®¡ç®—æ ‡ç­¾é¡µ -->
    <div id="batch-tab" class="tab-content">
      <div class="section">
        <h2>
          <span class="section-icon">ğŸ“‹</span>
          æ‰¹é‡è®¡ç®—
        </h2>
        
        <div class="input-group">
          <label style="width: 100%; margin-bottom: 10px;">ğŸ“ ç²˜è´´æ‰¹é‡æ•°æ®ï¼ˆæ”¯æŒè‡ªåŠ¨è¯†åˆ«æ ¼å¼ï¼‰</label>
        </div>
        <textarea id="batchInput" placeholder="è¯·ç²˜è´´æ‰¹é‡æ•°æ®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹ä¿¡æ¯ï¼š
- å¼€å…³åç§°
- å˜å‹å™¨å®¹é‡ï¼ˆæ”¯æŒkVAæ ¼å¼ï¼Œæ”¯æŒå¤šå°ç›¸åŠ å¦‚ï¼š1250kVA+1250kVAï¼‰
- ç›¸åºCTå˜æ¯”
- é›¶åºCTå˜æ¯”

ç³»ç»Ÿæ”¯æŒå¤šç§æ•°æ®æ ¼å¼ï¼š
1. å¸¦åºå·çš„æ ¼å¼ï¼ˆ1ã€2ã€3...ï¼‰
2. é€—å·åˆ†éš”çš„æ ¼å¼
3. é¡¹ç›®åç§°å¼€å¤´çš„æ ¼å¼
4. è‡ªç”±æ–‡æœ¬æ ¼å¼

ç¤ºä¾‹ï¼š
é¡¹ç›®åç§°ï¼šxxxé¡¹ç›®
å¼€å…³åç§°ï¼šç æ±ŸèŠ±åŸ2å·å¼€å…³æˆ¿G01æŸœ601å¼€å…³
å¼€å…³åæ®µå˜å‹å™¨å®¹é‡ï¼š630kVA
ç›¸åºCTå˜æ¯”ï¼š600/5 10P20çº§
é›¶åºCTå˜æ¯”ï¼š100/5 10P10çº§"></textarea>

        <div class="button-group">
          <button class="btn-primary" onclick="parseBatchData()">
            ğŸ” è§£ææ•°æ®
          </button>
          <button class="btn-success" onclick="calculateBatch()" id="batchCalculateBtn" disabled>
            ğŸ“Š æ‰¹é‡è®¡ç®—
          </button>
          <button class="btn-danger" onclick="clearBatchData()">
            ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
          </button>
          <button class="btn-secondary" onclick="exportBatchResults()" id="exportBatchBtn" disabled>
            ğŸ“¥ å¯¼å‡ºå…¨éƒ¨ç»“æœ
          </button>
          <button class="btn-warning" onclick="loadSampleData()">
            ğŸ“ åŠ è½½ç¤ºä¾‹æ•°æ®
          </button>
        </div>

        <!-- è§£æé¢„è§ˆ -->
        <div id="batchPreview" style="display: none;">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">è§£æç»“æœé¢„è§ˆ</h3>
          <div class="stats-container" id="batchStats"></div>
          <div class="batch-preview" id="batchPreviewContent"></div>
        </div>

        <!-- æ‰¹é‡è®¡ç®—ç»“æœ -->
        <div id="batchResults" class="batch-results" style="display: none;">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">æ‰¹é‡è®¡ç®—ç»“æœ</h3>
          <div class="button-group">
            <button class="btn-secondary" onclick="copyAllResults()">
              ğŸ“‹ å¤åˆ¶æ‰€æœ‰ç»“æœ
            </button>
            <button class="btn-primary" onclick="printBatchResults()">
              ğŸ–¨ï¸ æ‰“å°ç»“æœ
            </button>
          </div>
          <div id="batchResultsContent"></div>
        </div>
      </div>
    </div>

    <!-- æ–‡å­—å¤„ç†æ ‡ç­¾é¡µ -->
    <div id="text-tab" class="tab-content">
      <div class="section">
        <h2>
          <span class="section-icon">ğŸ“</span>
          æ–‡å­—æå–å¤„ç†
        </h2>
        <div class="input-group">
          <label>ğŸ“ è¾“å…¥æ–‡å­—</label>
          <input type="text" id="inputText" style="flex: 1;"
                 placeholder="ä¾‹å¦‚ï¼š10kVå‘˜çƒ­F29å‘˜æ‘çŸ³ä¸œè”ç¤¾ï¼ˆç§‘éŸµè·¯ï¼‰å¼€å…³æˆ¿G03æŸœ603å¼€å…³">
        </div>
        <div class="button-group">
          <button class="btn-success" onclick="processText()">
            ğŸ” å¤„ç†æ–‡å­—
          </button>
          <button class="btn-secondary" onclick="clearTextResults()">
            ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
          </button>
        </div>
        <div class="text-results" id="textResults" style="display: none;">
          <div class="text-result-item">
            <div class="text-result-label">å˜ç”µç«™åç§°</div>
            <div class="text-result-value" id="result1">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">é¦ˆçº¿</div>
            <div class="text-result-value" id="result2">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">å¼€å…³æˆ¿</div>
            <div class="text-result-value" id="result3">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">å¼€å…³åç§°</div>
            <div class="text-result-value" id="result4">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å®¹é‡é€‰æ‹©æ¨¡æ€æ¡† -->
  <div id="capacityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      <h3 style="margin-bottom: 25px; color: var(--primary-color); font-size: 1.5rem;">é€‰æ‹©å®¹é‡</h3>
      <div style="margin: 25px 0;">
        <label style="margin-right: 15px; font-weight: 600;">å®¹é‡ç±»å‹ï¼š</label>
        <select id="capacityType" onchange="updateCapacityOptions()" style="padding: 10px 20px; border-radius: var(--radius); border: 2px solid var(--border-color);">
          <option value="transformer">å˜å‹å™¨å®¹é‡ (kVA)</option>
          <option value="motor">ç”µæœºå®¹é‡ (kW)</option>
          <option value="custom">è‡ªå®šä¹‰å®¹é‡</option>
        </select>
      </div>
      <div id="capacityOptions" style="margin: 25px 0;"></div>
      <div class="button-group" style="justify-content: center; margin-top: 30px;">
        <button class="btn-primary" onclick="addSelectedCapacity()">ç¡®å®š</button>
        <button class="btn-secondary" onclick="closeCapacityModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let selectedCapacities = [];
    let batchData = [];
    let batchCalculationResults = [];
    const transformerCapacities = [30.5, 80, 100, 200, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3000];
    const motorCapacities = [5.5, 7.5, 11, 15, 18.5, 22, 30, 37, 45, 55, 75, 90, 110, 132, 160, 200, 250, 315];

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      updateCapacityDisplay();
    });

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function switchTab(tabName, element) {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
      element.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // åŠ è½½ç¤ºä¾‹æ•°æ®
    function loadSampleData() {
      const sampleData = `é¡¹ç›®åç§°ï¼šå¹¿å·å¸‚å¤©æ²³åŒºç å‰è¡—å‰å±±ç¬¬äºŒè‚¡ä»½åˆä½œç»æµç¤¾ä¸šæ‰©é…å¥—é¡¹ç›®
ç”µæˆ¿åç§°ï¼šç æ±ŸèŠ±åŸ2å·å¼€å…³æˆ¿
å¼€å…³åç§°ï¼šç æ±ŸèŠ±åŸ2å·å¼€å…³æˆ¿G01æŸœ601å¼€å…³
å¼€å…³åæ®µå˜å‹å™¨å®¹é‡ï¼š630kVA
æ–­è·¯å™¨æŸœå‚å®¶åç§°ï¼šç©‚è¾¾
å¾®æœºå‚å®¶åç§°ï¼šç æµ·ç§‘ä¼—
ç›¸åºCTå˜æ¯”ï¼š600/5 10P20çº§
é›¶åºCTå˜æ¯”ï¼š100/5 10P10çº§
é€ç”µæ—¶é—´ï¼š2025å¹´07æœˆ16æ—¥
ç”³è¯·åŸå› ï¼šæ–°æŠ•è¿

ï¼Œ1ã€é¡¹ç›®åç§°ï¼šå¤©æ²³åŒºé«˜æ™®è·¯68å·åœ°å—10kVä¾›ç”µè®¾æ–½è¿æ”¹é¡¹ç›®ï¼ˆä¸´è¿ï¼‰
ç”µæˆ¿åç§°ï¼š10kVé«˜å¡˜F10é«˜æ™®è·¯68å·å¼€å…³æˆ¿
å¼€å…³åç§°ï¼š10kVé«˜å¡˜F10é«˜æ™®è·¯68å·å¼€å…³æˆ¿G04æŸœ
å¼€å…³åæ®µå˜å‹å™¨å®¹é‡ï¼š1250kVA+1250kVA
æ–­è·¯å™¨æŸœå‚å®¶åç§°ï¼šå¸Œæ ¼ç›ç”µæ°”ï¼ˆç æµ·ï¼‰æœ‰é™å…¬å¸
å¾®æœºå‚å®¶åç§°ï¼šç æµ·ä¸‡åŠ›è¾¾ç”µæ°”æŠ€æœ¯è‚¡ä»½æœ‰é™å…¬å¸
ç›¸åºCTå˜æ¯”ï¼š600/5 10P10
é›¶åºCTå˜æ¯”ï¼š100/5 10P10
é€ç”µæ—¶é—´ï¼š2025.06.26
ç”³è¯·åŸå› ï¼šæ–°æŠ•äº§`;
      
      document.getElementById('batchInput').value = sampleData;
    }

    // è§£ææ‰¹é‡æ•°æ®
    function parseBatchData() {
      const input = document.getElementById('batchInput').value.trim();
      if (!input) {
        alert('è¯·è¾“å…¥æ‰¹é‡æ•°æ®');
        return;
      }

      batchData = [];
      
      // æ™ºèƒ½åˆ†å‰²æ•°æ®é¡¹ - æ”¯æŒå¤šç§åˆ†éš”æ–¹å¼
      let items = [];
      
      // é¦–å…ˆç§»é™¤å¯èƒ½çš„å¹²æ‰°æ–‡æœ¬ï¼ˆå¦‚ @æåŠï¼‰
      let cleanInput = input.replace(/@[\u4e00-\u9fa5\w\s]+/g, '');
      
      // å°è¯•æŒ‰æ•°å­—åºå·åˆ†å‰²ï¼ˆå¦‚ï¼š1ã€2ã€ç­‰ï¼‰
      if (cleanInput.match(/\d+[ã€.]\s*é¡¹ç›®åç§°/)) {
        items = cleanInput.split(/(?=\d+[ã€.]\s*é¡¹ç›®åç§°)/);
      }
      // å°è¯•æŒ‰"é¡¹ç›®åç§°"åˆ†å‰²ï¼ˆä½†éœ€è¦ç¡®ä¿æ˜¯ç‹¬ç«‹çš„é¡¹ç›®å¼€å§‹ï¼‰
      else if (cleanInput.includes('é¡¹ç›®åç§°')) {
        // ä½¿ç”¨æ›´ç²¾ç¡®çš„åˆ†å‰²æ–¹å¼ï¼Œé¿å…é”™è¯¯åˆ†å‰²
        items = cleanInput.split(/(?=é¡¹ç›®åç§°[ï¼š:])/).filter((item, index) => {
          // è¿‡æ»¤æ‰ç¬¬ä¸€ä¸ªç©ºé¡¹
          if (index === 0 && !item.trim()) return false;
          // ç¡®ä¿åŒ…å«å¿…è¦çš„å­—æ®µ
          return item.includes('å¼€å…³åç§°') && item.includes('å˜å‹å™¨å®¹é‡');
        });
      }
      // å°è¯•æŒ‰é€—å·å’Œæ¢è¡Œç¬¦ç»„åˆåˆ†å‰²
      else if (cleanInput.includes('ï¼Œ') && cleanInput.includes('å¼€å…³åç§°')) {
        items = cleanInput.split(/[ï¼Œ,]\s*(?=\d+[ã€.]|é¡¹ç›®åç§°)/);
      }
      // å°è¯•æŒ‰åŒæ¢è¡Œç¬¦åˆ†å‰²
      else {
        items = cleanInput.split(/\n\s*\n/);
      }
      
      items = items.filter(item => item.trim() && item.length > 50); // è¿‡æ»¤å¤ªçŸ­çš„é¡¹
      
      items.forEach((item, index) => {
        const data = {
          index: index + 1,
          rawText: item,
          parsed: {}
        };

        // æ™ºèƒ½è§£æå„å­—æ®µ
        
        // 1. è§£æå¼€å…³åç§° - æ”¯æŒå¤šç§æ ¼å¼
        const switchNamePatterns = [
          /å¼€å…³åç§°[ï¼š:]\s*([^\n]+?)(?=\n|$)/,
          /å¼€å…³åç§°[ï¼š:]\s*(.+?)(?=å¼€å…³åæ®µ|æ–­è·¯å™¨|å¾®æœº|ç›¸åº|é›¶åº|é€ç”µ|ç”³è¯·|$)/
        ];
        
        for (let pattern of switchNamePatterns) {
          const match = item.match(pattern);
          if (match) {
            data.parsed.switchName = match[1].trim();
            break;
          }
        }
        
        // 2. è§£æå˜å‹å™¨å®¹é‡ - æ”¯æŒå¤šå°å˜å‹å™¨
        const capacityPatterns = [
          /å˜å‹å™¨å®¹é‡[ï¼š:]\s*(.+?)(?=\n|æ–­è·¯å™¨|å¾®æœº|ç›¸åº|é›¶åº|é€ç”µ|ç”³è¯·|$)/,
          /(\d+(?:\.\d+)?\s*kVA(?:\s*[+ï¼‹]\s*\d+(?:\.\d+)?\s*kVA)*)/i
        ];
        
        for (let pattern of capacityPatterns) {
          const match = item.match(pattern);
          if (match) {
            const capacityStr = match[1];
            // å¤„ç†å¤šå°å˜å‹å™¨çš„æƒ…å†µ
            if (capacityStr.includes('+') || capacityStr.includes('ï¼‹')) {
              const capacities = capacityStr.match(/\d+(?:\.\d+)?/g);
              if (capacities) {
                // ä¿å­˜å¤šå°å˜å‹å™¨çš„å®¹é‡æ•°ç»„
                data.parsed.capacities = capacities.map(cap => parseFloat(cap));
                data.parsed.capacityUnit = 'kVA';
                data.parsed.isMultiple = true;
                data.parsed.capacityNote = `${capacities.length}å°å˜å‹å™¨ï¼š${capacityStr}`;
                // ç”¨äºæ˜¾ç¤ºï¼Œä½†ä¸ç”¨äºè®¡ç®—
                data.parsed.capacity = data.parsed.capacities[0]; // ä½¿ç”¨ç¬¬ä¸€å°çš„å®¹é‡æ˜¾ç¤º
              }
            } else {
              const singleCapMatch = capacityStr.match(/(\d+(?:\.\d+)?)\s*kVA/i);
              if (singleCapMatch) {
                data.parsed.capacity = parseFloat(singleCapMatch[1]);
                data.parsed.capacityUnit = 'kVA';
                data.parsed.isMultiple = false;
                data.parsed.capacities = [parseFloat(singleCapMatch[1])]; // ç¡®ä¿å•å°ä¹Ÿæœ‰capacitiesæ•°ç»„
              }
            }
            break;
          }
        }
        
        // 3. è§£æç›¸åºCTå˜æ¯” - æ”¯æŒå¤šç§æ ¼å¼
        const k3Patterns = [
          /ç›¸åºCTå˜æ¯”[ï¼š:]\s*(\d+)\s*\/\s*(\d+)/,
          /ç›¸åºCT[ï¼š:]\s*(\d+)\s*\/\s*(\d+)/,
          /ç›¸åºå˜æ¯”[ï¼š:]\s*(\d+)\s*\/\s*(\d+)/
        ];
        
        for (let pattern of k3Patterns) {
          const match = item.match(pattern);
          if (match) {
            data.parsed.k3 = `${match[1]}/${match[2]}`;
            break;
          }
        }
        
        // 4. è§£æé›¶åºCTå˜æ¯” - æ”¯æŒå¤šç§æ ¼å¼
        const k0Patterns = [
          /é›¶åºCTå˜æ¯”[ï¼š:]\s*(\d+)\s*\/\s*(\d+)/,
          /é›¶åºCT[ï¼š:]\s*(\d+)\s*\/\s*(\d+)/,
          /é›¶åºå˜æ¯”[ï¼š:]\s*(\d+)\s*\/\s*(\d+)/
        ];
        
        for (let pattern of k0Patterns) {
          const match = item.match(pattern);
          if (match) {
            data.parsed.k0 = `${match[1]}/${match[2]}`;
            break;
          }
        }
        
        // 5. æå–å…¶ä»–æœ‰ç”¨ä¿¡æ¯
        // é¡¹ç›®åç§°
        const projectMatch = item.match(/é¡¹ç›®åç§°[ï¼š:]\s*(.+?)(?=\n|ç”µæˆ¿|$)/);
        if (projectMatch) {
          data.parsed.projectName = projectMatch[1].trim();
        }
        
        // ç”µæˆ¿åç§°
        const roomMatch = item.match(/ç”µæˆ¿åç§°[ï¼š:]\s*(.+?)(?=\n|å¼€å…³åç§°|$)/);
        if (roomMatch) {
          data.parsed.roomName = roomMatch[1].trim();
        }
        
        // é€ç”µæ—¶é—´
        const dateMatch = item.match(/é€ç”µæ—¶é—´[ï¼š:]\s*(.+?)(?=\n|ç”³è¯·|$)/);
        if (dateMatch) {
          data.parsed.powerOnDate = dateMatch[1].trim();
        }

        // æ£€æŸ¥å¿…è¦å­—æ®µ
        if (data.parsed.switchName && data.parsed.capacity && data.parsed.k3 && data.parsed.k0) {
          data.status = 'success';
        } else {
          data.status = 'error';
          const missingFields = [];
          if (!data.parsed.switchName) missingFields.push('å¼€å…³åç§°');
          if (!data.parsed.capacity) missingFields.push('å˜å‹å™¨å®¹é‡');
          if (!data.parsed.k3) missingFields.push('ç›¸åºCTå˜æ¯”');
          if (!data.parsed.k0) missingFields.push('é›¶åºCTå˜æ¯”');
          data.error = `ç¼ºå°‘å­—æ®µï¼š${missingFields.join('ã€')}`;
        }

        batchData.push(data);
      });

      // æ˜¾ç¤ºè§£æç»“æœ
      displayBatchPreview();
    }

    // æ˜¾ç¤ºæ‰¹é‡æ•°æ®é¢„è§ˆ
    function displayBatchPreview() {
      const previewContainer = document.getElementById('batchPreview');
      const previewContent = document.getElementById('batchPreviewContent');
      const statsContainer = document.getElementById('batchStats');
      
      // ç»Ÿè®¡ä¿¡æ¯
      const successCount = batchData.filter(d => d.status === 'success').length;
      const errorCount = batchData.filter(d => d.status === 'error').length;
      
      statsContainer.innerHTML = `
        <div class="stat-item">
          <div class="stat-value">${batchData.length}</div>
          <div class="stat-label">æ€»æ•°æ®æ¡æ•°</div>
        </div>
        <div class="stat-item" style="background: var(--success-light);">
          <div class="stat-value" style="color: var(--success-color);">${successCount}</div>
          <div class="stat-label">è§£ææˆåŠŸ</div>
        </div>
        <div class="stat-item" style="background: var(--danger-light);">
          <div class="stat-value" style="color: var(--danger-color);">${errorCount}</div>
          <div class="stat-label">è§£æå¤±è´¥</div>
        </div>
      `;
      
      // é¢„è§ˆå†…å®¹
      previewContent.innerHTML = '';
      batchData.forEach(data => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `batch-item ${data.status === 'error' ? 'error' : ''}`;
        
        if (data.status === 'success') {
          const capacityDisplay = data.parsed.isMultiple && data.parsed.capacities 
            ? `${data.parsed.capacities.join('+')} ${data.parsed.capacityUnit}` 
            : `${data.parsed.capacity} ${data.parsed.capacityUnit}`;
            
          itemDiv.innerHTML = `
            <div class="batch-item-header">
              <span>åºå· ${data.index}: ${data.parsed.switchName}</span>
              <span style="color: var(--success-color);">âœ“</span>
            </div>
            <div class="batch-item-details">
              <div>å®¹é‡: ${capacityDisplay} ${data.parsed.capacityNote ? `(${data.parsed.capacityNote})` : ''}</div>
              <div>ç›¸åºå˜æ¯”: ${data.parsed.k3}</div>
              <div>é›¶åºå˜æ¯”: ${data.parsed.k0}</div>
              ${data.parsed.projectName ? `<div>é¡¹ç›®: ${data.parsed.projectName}</div>` : ''}
              ${data.parsed.powerOnDate ? `<div>é€ç”µæ—¶é—´: ${data.parsed.powerOnDate}</div>` : ''}
            </div>
          `;
        } else {
          itemDiv.innerHTML = `
            <div class="batch-item-header">
              <span>åºå· ${data.index}</span>
              <span style="color: var(--danger-color);">âœ— ${data.error}</span>
            </div>
            <div class="batch-item-details" style="color: var(--danger-color);">
              ${data.rawText.substring(0, 100)}...
            </div>
          `;
        }
        
        previewContent.appendChild(itemDiv);
      });
      
      previewContainer.style.display = 'block';
      
      // å¯ç”¨/ç¦ç”¨æ‰¹é‡è®¡ç®—æŒ‰é’®
      document.getElementById('batchCalculateBtn').disabled = successCount === 0;
    }

    // æ‰¹é‡è®¡ç®—
    function calculateBatch() {
      batchCalculationResults = [];
      const successData = batchData.filter(d => d.status === 'success');
      
      successData.forEach(data => {
        let capacities;
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå¤šå°å˜å‹å™¨
        if (data.parsed.isMultiple && data.parsed.capacities) {
          // å¤šå°å˜å‹å™¨ï¼Œæ¯å°éƒ½ä½œä¸ºç‹¬ç«‹çš„å®¹é‡
          capacities = data.parsed.capacities.map(cap => ({ type: 'transformer', value: cap }));
        } else {
          // å•å°å˜å‹å™¨
          capacities = [{ type: 'transformer', value: data.parsed.capacity }];
        }
        
        const result = calculateSingle(
          data.parsed.switchName,
          data.parsed.k3,
          data.parsed.k0,
          capacities,
          'no' // é»˜è®¤ä½¿ç”¨æ ‡å‡†CT
        );
        
        batchCalculationResults.push({
          ...data,
          calculation: result
        });
      });
      
      displayBatchResults();
    }

    // å•ä¸ªè®¡ç®—æ ¸å¿ƒå‡½æ•°
    function calculateSingle(switchName, k3Input, k0Input, capacities, ctOption) {
      const k3 = parseRatio(k3Input);
      const k0 = parseRatio(k0Input);

      if (!k3 || !k0 || k3 <= 0 || k0 <= 0) {
        return null;
      }

      const transformerCaps = capacities.filter(c => c.type === 'transformer').map(c => c.value);
      const motorCaps = capacities.filter(c => c.type === 'motor').map(c => c.value);

      // è®¡ç®—å˜å‹å™¨è´Ÿè·ç”µæµ
      const transformerLoadCurrent = transformerCaps.length > 0 ?
            transformerCaps.reduce((sum, cap) => sum + cap, 0) / (10.5 * 1.732) : 0;

      // è®¡ç®—ä¸€æ®µä¿æŠ¤å®šå€¼
      let firstProtection = 0;
      if (transformerCaps.length > 0) {
        const maxNormal = Math.max(...transformerCaps);
        const countNormal = transformerCaps.length;
        const coefficient = countNormal <= 3 ? 25 : (countNormal <= 6 ? 30 : 35);
        const firstProtectionCalc = (maxNormal * coefficient) / (10.5 * 1.732);
        firstProtection = Math.max(0.57, Math.min(firstProtectionCalc, 2479) / k3);
      } else if (motorCaps.length > 0) {
        const maxMotor = Math.max(...motorCaps);
        const countMotor = motorCaps.length;
        const coefficient = countMotor <= 3 ? 25 : (countMotor <= 6 ? 30 : 35);
        const firstProtectionCalc = (maxMotor * coefficient) / (10.5 * 1.732);
        firstProtection = Math.max(0.57, Math.min(firstProtectionCalc, 2479) / k3);
      }

      // è®¡ç®—ç”µæœºè´Ÿè·ç”µæµ
      let motorLoadCurrent = 0;
      if (motorCaps.length > 0) {
        if (motorCaps.length === 1) {
          motorLoadCurrent = motorCaps[0] * 9 / 100 * 8;
        } else {
          let sum = 0;
          for (let i = 0; i < motorCaps.length - 1; i++) {
            sum += motorCaps[i] * 9 / 100;
          }
          let lastMotor = motorCaps[motorCaps.length - 1] * 9 / 100 * 8;
          motorLoadCurrent = sum + lastMotor;
        }
      }

      // è®¡ç®—äºŒæ®µä¿æŠ¤ç”¨è´Ÿè·ç”µæµ
      let loadCurrentForSecond;
      if (transformerCaps.length > 0 && motorCaps.length > 0) {
        loadCurrentForSecond = (transformerLoadCurrent + motorLoadCurrent) * 1.3;
      } else if (motorCaps.length > 0) {
        loadCurrentForSecond = motorLoadCurrent * 1.3;
      } else {
        loadCurrentForSecond = transformerLoadCurrent;
      }

      // è®¡ç®—äºŒæ®µä¿æŠ¤å®šå€¼
      let secondProtection;
      if (loadCurrentForSecond > 548) {
        secondProtection = 1040 * 0.82 / k3;
      } else {
        const baseValue = Math.max(1.56 * loadCurrentForSecond, 0.1) / k3;
        let minCapacity;
        if (transformerCaps.length > 0) {
          minCapacity = Math.min(...transformerCaps);
        } else if (motorCaps.length > 0) {
          minCapacity = Math.min(...motorCaps);
        }
        
        let capacityBased;
        if (minCapacity < 315) {
          capacityBased = 8 * minCapacity / (10.5 * 1.732 * k3);
        } else {
          const capacityMap = {
            315: 150, 400: 190, 500: 220, 630: 260, 800: 310
          };
          if (capacityMap[minCapacity]) {
            capacityBased = capacityMap[minCapacity] / k3;
          } else if (minCapacity > 2000) {
            capacityBased = 5 * minCapacity / (10.5 * 1.732 * k3);
          } else {
            capacityBased = 6 * minCapacity / (10.5 * 1.732 * k3);
          }
        }
        secondProtection = Math.max(0.18, Math.max(baseValue, capacityBased));
      }
      
      // CTé€‰é¡¹å¤„ç†
      if (ctOption === 'yes' && secondProtection > 5.33) {
        secondProtection = 5.33;
      }

      // ç¡®ä¿ä¸€æ®µå®šå€¼å¤§äºäºŒæ®µå®šå€¼çš„1.1å€
      if (firstProtection < secondProtection * 1.1) {
        firstProtection = secondProtection * 1.1;
      }

      // è®¡ç®—ä¸€æ¬¡å€¼
      const firstProtectionPrimary = firstProtection * k3;
      const secondProtectionPrimary = secondProtection * k3;

      // è®¡ç®—é›¶åºå®šå€¼
      const zeroSequence = 2.25 / k0 * 20;

      return {
        loadCurrent: loadCurrentForSecond,
        firstProtection: firstProtection,
        secondProtection: secondProtection,
        firstProtectionPrimary: firstProtectionPrimary,
        secondProtectionPrimary: secondProtectionPrimary,
        zeroSequence: zeroSequence,
        warning: loadCurrentForSecond > 853.2
      };
    }

    // æ˜¾ç¤ºæ‰¹é‡è®¡ç®—ç»“æœ
    function displayBatchResults() {
      const resultsContainer = document.getElementById('batchResults');
      const resultsContent = document.getElementById('batchResultsContent');
      
      resultsContent.innerHTML = '';
      
      batchCalculationResults.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'batch-result-item';
        
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}ï¼š` : '';
        
        // å®¹é‡æ˜¾ç¤ºå¤„ç†
        const capacityDisplay = result.parsed.isMultiple && result.parsed.capacities 
          ? `${result.parsed.capacities.join('+')} ${result.parsed.capacityUnit}` 
          : `${result.parsed.capacity} ${result.parsed.capacityUnit}`;
        
        resultDiv.innerHTML = `
          <div class="batch-result-header">
            <span>ğŸ“Š</span>
            åºå· ${result.index}: ${result.parsed.switchName}
          </div>
          <div class="batch-result-grid">
            <div>
              <div class="result-label">å®¹é‡</div>
              <div style="font-weight: bold;">${capacityDisplay}</div>
            </div>
            <div>
              <div class="result-label">è´Ÿè·ç”µæµ</div>
              <div style="font-weight: bold;">${calc.loadCurrent.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">ä¸€æ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.firstProtection.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">äºŒæ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.secondProtection.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">é›¶åºå®šå€¼</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.zeroSequence.toFixed(2)} A</div>
            </div>
          </div>
          <div class="text-result">
            <strong>å®šå€¼é…ç½®å»ºè®®ï¼š</strong>${switchPrefix}ä¸€æ®µ ${calc.firstProtection.toFixed(2)}A 0.05ç§’  äºŒæ®µ ${calc.secondProtection.toFixed(2)}A 0.3ç§’  é›¶åº ${calc.zeroSequence.toFixed(2)}A 0.4ç§’
          </div>
          ${calc.warning ? '<div class="warning-message"><span>âš ï¸</span><span>è´Ÿè·ç”µæµè¶…è¿‡æœ€å¤§å€¼ï¼Œå»ºè®®è€ƒè™‘ä¸“çº¿ä¾›ç”µæ–¹æ¡ˆã€‚</span></div>' : ''}
        `;
        
        resultsContent.appendChild(resultDiv);
      });
      
      resultsContainer.style.display = 'block';
      document.getElementById('exportBatchBtn').disabled = false;
      
      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // å¯¼å‡ºæ‰¹é‡ç»“æœ
    function exportBatchResults() {
      if (batchCalculationResults.length === 0) {
        alert('è¯·å…ˆè¿›è¡Œæ‰¹é‡è®¡ç®—');
        return;
      }
      
      let exportText = `å˜å‹å™¨ç»§ä¿å®šå€¼æ‰¹é‡è®¡ç®—ç»“æœ
=====================================
è®¡ç®—æ—¶é—´ï¼š${new Date().toLocaleString()}
è®¡ç®—æ•°é‡ï¼š${batchCalculationResults.length} æ¡

`;
      
      batchCalculationResults.forEach(result => {
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}ï¼š` : '';
        
        // å®¹é‡æ˜¾ç¤ºå¤„ç†
        const capacityDisplay = result.parsed.isMultiple && result.parsed.capacities 
          ? `${result.parsed.capacities.join('+')} ${result.parsed.capacityUnit}` 
          : `${result.parsed.capacity} ${result.parsed.capacityUnit}`;
        
        exportText += `
ã€åºå· ${result.index}ã€‘
å¼€å…³åç§°ï¼š${result.parsed.switchName}
å®¹é‡ï¼š${capacityDisplay}${result.parsed.capacityNote ? ` (${result.parsed.capacityNote})` : ''}
ç›¸åºå˜æ¯”ï¼š${result.parsed.k3}
é›¶åºå˜æ¯”ï¼š${result.parsed.k0}

è®¡ç®—ç»“æœï¼š
è´Ÿè·ç”µæµï¼š${calc.loadCurrent.toFixed(2)} A
ä¸€æ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰ï¼š${calc.firstProtection.toFixed(2)} A
äºŒæ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰ï¼š${calc.secondProtection.toFixed(2)} A
ä¸€æ®µå®šå€¼ï¼ˆä¸€æ¬¡å€¼ï¼‰ï¼š${calc.firstProtectionPrimary.toFixed(2)} A
äºŒæ®µå®šå€¼ï¼ˆä¸€æ¬¡å€¼ï¼‰ï¼š${calc.secondProtectionPrimary.toFixed(2)} A
é›¶åºå®šå€¼ï¼š${calc.zeroSequence.toFixed(2)} A

å®šå€¼é…ç½®å»ºè®®ï¼š${switchPrefix}ä¸€æ®µ ${calc.firstProtection.toFixed(2)}A 0.05ç§’  äºŒæ®µ ${calc.secondProtection.toFixed(2)}A 0.3ç§’  é›¶åº ${calc.zeroSequence.toFixed(2)}A 0.4ç§’
${calc.warning ? '\nâš ï¸ è­¦å‘Šï¼šè´Ÿè·ç”µæµè¶…è¿‡æœ€å¤§å€¼ï¼Œå»ºè®®è€ƒè™‘ä¸“çº¿ä¾›ç”µæ–¹æ¡ˆã€‚' : ''}
=====================================
`;
      });
      
      exportText += `
å˜å‹å™¨ç»§ä¿å®šå€¼è®¡ç®—å™¨ v6.0
å¼€å‘è€…ï¼šéŸ©ç¿°`;
      
      // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
      const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `æ‰¹é‡å®šå€¼è®¡ç®—_${new Date().getTime()}.txt`;
      link.click();
    }

    // å¤åˆ¶æ‰€æœ‰ç»“æœ
    function copyAllResults() {
      if (batchCalculationResults.length === 0) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„ç»“æœ');
        return;
      }
      
      let copyText = '';
      batchCalculationResults.forEach(result => {
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}ï¼š` : '';
        copyText += `${switchPrefix}ä¸€æ®µ ${calc.firstProtection.toFixed(2)}A 0.05ç§’  äºŒæ®µ ${calc.secondProtection.toFixed(2)}A 0.3ç§’  é›¶åº ${calc.zeroSequence.toFixed(2)}A 0.4ç§’\n`;
      });
      
      navigator.clipboard.writeText(copyText).then(() => {
        // åˆ›å»ºæˆåŠŸæç¤º
        const successMsg = document.createElement('div');
        successMsg.className = 'success-message';
        successMsg.innerHTML = '<span>âœ“</span><span>å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>';
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      }).catch(() => {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      });
    }

    // æ‰“å°æ‰¹é‡ç»“æœ
    function printBatchResults() {
      window.print();
    }

    // æ¸…ç©ºæ‰¹é‡æ•°æ®
    function clearBatchData() {
      document.getElementById('batchInput').value = '';
      document.getElementById('batchPreview').style.display = 'none';
      document.getElementById('batchResults').style.display = 'none';
      document.getElementById('batchCalculateBtn').disabled = true;
      document.getElementById('exportBatchBtn').disabled = true;
      batchData = [];
      batchCalculationResults = [];
    }

    // æ˜¾ç¤ºå®¹é‡é€‰æ‹©å™¨
    function showCapacitySelector() {
      document.getElementById('capacityModal').style.display = 'block';
      updateCapacityOptions();
    }

    // å…³é—­å®¹é‡é€‰æ‹©å™¨
    function closeCapacityModal() {
      document.getElementById('capacityModal').style.display = 'none';
    }

    // æ›´æ–°å®¹é‡é€‰é¡¹
    function updateCapacityOptions() {
      const type = document.getElementById('capacityType').value;
      const container = document.getElementById('capacityOptions');
      container.innerHTML = '';

      if (type === 'transformer') {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        grid.style.gap = '12px';
        
        transformerCapacities.forEach(cap => {
          const btn = document.createElement('button');
          btn.className = 'btn-primary';
          btn.style.padding = '12px';
          btn.textContent = cap + ' kVA';
          btn.onclick = () => {
            selectedCapacities.push({ type: 'transformer', value: cap });
            updateCapacityDisplay();
            closeCapacityModal();
          };
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      } else if (type === 'motor') {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        grid.style.gap = '12px';
        
        motorCapacities.forEach(cap => {
          const btn = document.createElement('button');
          btn.className = 'btn-primary';
          btn.style.padding = '12px';
          btn.textContent = cap + ' kW';
          btn.onclick = () => {
            selectedCapacities.push({ type: 'motor', value: cap });
            updateCapacityDisplay();
            closeCapacityModal();
          };
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      } else {
        container.innerHTML = `
          <div class="input-group" style="flex-direction: row;">
            <label>è¾“å…¥å®¹é‡å€¼ï¼š</label>
            <input type="number" id="customCapacityValue" min="0" step="0.1" style="flex: 1;">
            <select id="customCapacityUnit" style="width: auto; min-width: 150px;">
              <option value="kVA">kVA (å˜å‹å™¨)</option>
              <option value="kW">kW (ç”µæœº)</option>
            </select>
          </div>
        `;
      }
    }

    // æ·»åŠ è‡ªå®šä¹‰å®¹é‡
    function addSelectedCapacity() {
      const type = document.getElementById('capacityType').value;
      if (type === 'custom') {
        const value = parseFloat(document.getElementById('customCapacityValue').value);
        const unit = document.getElementById('customCapacityUnit').value;
        if (value && value > 0) {
          selectedCapacities.push({ 
            type: unit === 'kVA' ? 'transformer' : 'motor', 
            value: value 
          });
          updateCapacityDisplay();
          closeCapacityModal();
        } else {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å®¹é‡å€¼');
        }
      }
    }

    // æ›´æ–°å®¹é‡æ˜¾ç¤º
    function updateCapacityDisplay() {
      const count = selectedCapacities.length;
      document.getElementById('capacityCount').textContent = `å·²é€‰æ‹© ${count} ä¸ªå®¹é‡`;
      
      const listContainer = document.getElementById('selectedList');
      const selectedContainer = document.getElementById('selectedCapacities');
      
      if (count > 0) {
        selectedContainer.style.display = 'block';
        listContainer.innerHTML = '';
        
        selectedCapacities.forEach((cap, index) => {
          const item = document.createElement('div');
          
          const text = document.createElement('span');
          text.textContent = `${cap.value} ${cap.type === 'transformer' ? 'kVA' : 'kW'}`;
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Ã—';
          removeBtn.onclick = () => {
            selectedCapacities.splice(index, 1);
            updateCapacityDisplay();
          };
          
          item.appendChild(text);
          item.appendChild(removeBtn);
          listContainer.appendChild(item);
        });
      } else {
        selectedContainer.style.display = 'none';
      }
    }

    // è§£æå˜æ¯”å€¼
    function parseRatio(ratioStr) {
      const match = ratioStr.match(/(\d+)\s*\/\s*(\d+)/);
      if (match) {
        return parseFloat(match[1]) / parseFloat(match[2]);
      }
      return null;
    }

    // è®¡ç®—åŠŸèƒ½
    function calculate() {
      try {
        const switchName = document.getElementById('switchName').value.trim();
        const k3Input = document.getElementById('k3').value.trim();
        const k0Input = document.getElementById('k0').value.trim();
        const ctOption = document.getElementById('ctOption').value;

        const k3 = parseRatio(k3Input);
        const k0 = parseRatio(k0Input);

        if (!k3 || !k0 || k3 <= 0 || k0 <= 0) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å˜æ¯”å€¼ï¼Œæ ¼å¼ï¼šXX/5');
          return;
        }

        if (selectedCapacities.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå®¹é‡å€¼');
          return;
        }

        const result = calculateSingle(switchName, k3Input, k0Input, selectedCapacities, ctOption);

        if (!result) {
          alert('è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å€¼');
          return;
        }

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('loadCurrent').textContent = result.loadCurrent.toFixed(2) + ' A';
        document.getElementById('firstProtection').textContent = result.firstProtection.toFixed(2) + ' A';
        document.getElementById('secondProtection').textContent = result.secondProtection.toFixed(2) + ' A';
        document.getElementById('firstProtectionPrimary').textContent = result.firstProtectionPrimary.toFixed(2) + ' A';
        document.getElementById('secondProtectionPrimary').textContent = result.secondProtectionPrimary.toFixed(2) + ' A';
        document.getElementById('zeroSequence').textContent = result.zeroSequence.toFixed(2) + ' A';
        
        // è·å–å¼€å…³åç§°
        const switchPrefix = switchName ? `${switchName}ï¼š` : '';
        
        document.getElementById('textResult').innerHTML = `
          <strong>å®šå€¼é…ç½®å»ºè®®ï¼š</strong>${switchPrefix}ä¸€æ®µ ${result.firstProtection.toFixed(2)}A 0.05ç§’  äºŒæ®µ ${result.secondProtection.toFixed(2)}A 0.3ç§’  é›¶åº ${result.zeroSequence.toFixed(2)}A 0.4ç§’
        `;
        
        document.getElementById('results').style.display = 'block';

        // è­¦å‘Šä¿¡æ¯å¤„ç†
        const warningContainer = document.getElementById('warningContainer');
        warningContainer.innerHTML = '';
        
        if (result.warning) {
          warningContainer.innerHTML = `
            <div class="warning-message">
              <span>âš ï¸</span>
              <span>è´Ÿè·ç”µæµå·²è¾¾æœ€å¤§å€¼ï¼ˆ${result.loadCurrent.toFixed(2)}A > 853.2Aï¼‰ï¼Œè®¡ç®—ç»“æœå¯èƒ½ä¸é€‚ç”¨ï¼Œå»ºè®®è€ƒè™‘ä¸“çº¿ä¾›ç”µæ–¹æ¡ˆã€‚</span>
            </div>
          `;
        }

        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'center' });

      } catch (error) {
        alert('è®¡ç®—å‡ºé”™ï¼š' + error.message);
        console.error('è®¡ç®—é”™è¯¯ï¼š', error);
      }
    }

    // é‡ç½®å®¹é‡
    function resetCapacities() {
      if (selectedCapacities.length > 0 && !confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²é€‰å®¹é‡å—ï¼Ÿ')) {
        return;
      }
      
      selectedCapacities = [];
      updateCapacityDisplay();
      
      // æ¸…ç©ºç»“æœ
      document.getElementById('results').style.display = 'none';
      const resultIds = ['loadCurrent', 'firstProtection', 'secondProtection', 
                        'firstProtectionPrimary', 'secondProtectionPrimary', 'zeroSequence'];
      resultIds.forEach(id => {
        document.getElementById(id).textContent = '-';
      });
      document.getElementById('textResult').innerHTML = '';
      document.getElementById('warningContainer').innerHTML = '';
    }

    // æ–‡å­—å¤„ç†åŠŸèƒ½
    function processText() {
      const text = document.getElementById('inputText').value.trim();
      
      if (!text) {
        alert('è¯·è¾“å…¥è¦å¤„ç†çš„æ–‡å­—');
        return;
      }
      
      try {
        // æ›´æ™ºèƒ½çš„æ–‡å­—è§£æ
        let result1 = '', result2 = '', result3 = '', result4 = '';
        
        // è§£æå˜ç”µç«™åç§°
        const stationMatch = text.match(/10kV(.+?)F\d+/);
        if (stationMatch) {
          result1 = stationMatch[1].trim();
        }
        
        // è§£æé¦ˆçº¿
        const feederMatch = text.match(/(10kV.+?F\d+)/);
        if (feederMatch) {
          result2 = feederMatch[1].replace('10kV', '').trim();
        }
        
        // è§£æå¼€å…³æˆ¿
        const switchRoomMatch = text.match(/(.+?)G\d+/);
        if (switchRoomMatch) {
          result3 = switchRoomMatch[1].trim();
        }
        
        // è§£æå¼€å…³åç§°
        const switchNameMatch = text.match(/F\d+(.+?)$/);
        if (switchNameMatch) {
          result4 = switchNameMatch[1].trim();
        }

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('result1').textContent = result1 || 'æœªè¯†åˆ«';
        document.getElementById('result2').textContent = result2 || 'æœªè¯†åˆ«';
        document.getElementById('result3').textContent = result3 || 'æœªè¯†åˆ«';
        document.getElementById('result4').textContent = result4 || 'æœªè¯†åˆ«';
        document.getElementById('textResults').style.display = 'grid';
        
      } catch (error) {
        alert('å¤„ç†æ–‡å­—æ—¶å‡ºé”™ï¼š' + error.message);
        console.error('æ–‡å­—å¤„ç†é”™è¯¯ï¼š', error);
      }
    }

    // æ¸…ç©ºæ–‡å­—å¤„ç†ç»“æœ
    function clearTextResults() {
      document.getElementById('inputText').value = '';
      document.getElementById('result1').textContent = '-';
      document.getElementById('result2').textContent = '-';
      document.getElementById('result3').textContent = '-';
      document.getElementById('result4').textContent = '-';
      document.getElementById('textResults').style.display = 'none';
    }

    // å¯¼å‡ºç»“æœåŠŸèƒ½
    function exportResults() {
      if (document.getElementById('results').style.display === 'none') {
        alert('è¯·å…ˆè¿›è¡Œè®¡ç®—');
        return;
      }
      
      const switchName = document.getElementById('switchName').value.trim();
      const k3Input = document.getElementById('k3').value.trim();
      const k0Input = document.getElementById('k0').value.trim();
      const ctOption = document.getElementById('ctOption').value === 'yes' ? '600A (å˜ç”µç«™)' : 'æ ‡å‡†';
      
      const capacityList = selectedCapacities.map(cap => 
        `${cap.value} ${cap.type === 'transformer' ? 'kVA' : 'kW'}`
      ).join(', ');
      
      const results = `å˜å‹å™¨ç»§ä¿å®šå€¼è®¡ç®—ç»“æœ
=====================================
è®¡ç®—æ—¶é—´ï¼š${new Date().toLocaleString()}

ã€è¾“å…¥å‚æ•°ã€‘
å¼€å…³åç§°ï¼š${switchName || 'æœªå¡«å†™'}
ç›¸åºå˜æ¯”ï¼š${k3Input}
é›¶åºå˜æ¯”ï¼š${k0Input}
ç«™å‡ºçº¿CTè§„æ ¼ï¼š${ctOption}
å·²é€‰å®¹é‡ï¼š${capacityList}

ã€è®¡ç®—ç»“æœã€‘
è´Ÿè·ç”µæµï¼š${document.getElementById('loadCurrent').textContent}
ä¸€æ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰ï¼š${document.getElementById('firstProtection').textContent}
äºŒæ®µå®šå€¼ï¼ˆäºŒæ¬¡å€¼ï¼‰ï¼š${document.getElementById('secondProtection').textContent}
ä¸€æ®µå®šå€¼ï¼ˆä¸€æ¬¡å€¼ï¼‰ï¼š${document.getElementById('firstProtectionPrimary').textContent}
äºŒæ®µå®šå€¼ï¼ˆä¸€æ¬¡å€¼ï¼‰ï¼š${document.getElementById('secondProtectionPrimary').textContent}
é›¶åºå®šå€¼ï¼š${document.getElementById('zeroSequence').textContent}

ã€å®šå€¼é…ç½®å»ºè®®ã€‘
${document.getElementById('textResult').innerText}

${document.getElementById('warningContainer').innerText || ''}
=====================================
å˜å‹å™¨ç»§ä¿å®šå€¼è®¡ç®—å™¨ v7.0
å¼€å‘è€…ï¼šéŸ©ç¿°`;

      // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
      const blob = new Blob([results], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `å˜å‹å™¨å®šå€¼è®¡ç®—_${new Date().getTime()}.txt`;
      link.click();
    }

    // é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
      // Ctrl + Enter è®¡ç®—
      if (e.ctrlKey && e.key === 'Enter') {
        calculate();
      }
      // Ctrl + R é‡ç½®
      else if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        resetCapacities();
      }
      // Ctrl + S å¯¼å‡º
      else if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        exportResults();
      }
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('capacityModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCapacityModal();
      }
    });

    // è¾“å…¥éªŒè¯
    document.getElementById('k3').addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !value.match(/^\d+\s*\/\s*\d+$/)) {
        this.style.borderColor = 'var(--danger-color)';
      } else {
        this.style.borderColor = '';
      }
    });

    document.getElementById('k0').addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !value.match(/^\d+\s*\/\s*\d+$/)) {
        this.style.borderColor = 'var(--danger-color)';
      } else {
        this.style.borderColor = '';
      }
    });
  </script>
</body>
</html>
