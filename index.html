<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>变压器继保定值计算器v4.0</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .input-group {
        flex-direction: column;
        align-items: flex-start;
      }
      label {
        width: 100%;
        margin-bottom: 5px;
      }
      input, select {
        width: 100%;
      }
      button {
        width: 100%;
        padding: 10px;
      }
      .capacity-grid {
        grid-template-columns: 1fr; 
      }
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
    }
    h1, h2 {
      color: #333;
      margin-bottom: 20px;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    .input-group {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    label {
      min-width: 150px;
      font-size: 16px;
    }
    input, select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      width: 200px;
    }
    .capacity-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px 0;
    }
    /* 公共按钮样式 */
    button {
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px 0;
      transition: background-color 0.3s;
    }
    /* 计算变压器定值按钮样式 */
    .calc-button {
      background-color: #1890ff;
      margin-right: 20px; /* 增加右侧间距 */
    }
    .calc-button:hover {
      background-color: #40a9ff;
    }
    /* 清空容量按钮样式 */
    .reset-button {
      background-color: #f44336;
    }
    .reset-button:hover {
      background-color: #e57373;
    }
    .results {
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
    .text-result {
      margin-top: 15px;
      padding: 15px;
      background-color: #e6f7ff;
      border-radius: 4px;
      font-size: 16px;
      line-height: 1.5;
    }
    .text-processing {
      margin-top: 30px;
    }
    .text-input {
      width: 100%;
      margin-bottom: 15px;
    }
    .result-item {
      background-color: #f8f9fa;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
    }
    input, select {
      max-width: 100%; 
      box-sizing: border-box; 
    }
    .capacity-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); 
      gap: 20px;
      margin: 20px 0;
    }
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .input-group {
        flex-direction: column; 
        align-items: flex-start;
      }
      label {
        width: 100%; 
        margin-bottom: 5px;
      }
      input, select {
        width: 100%; 
      }
      .capacity-grid {
        grid-template-columns: 1fr; 
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>变压器继保定值计算器 v4.0 by hanhan</h1>
    
    <!-- 变压器计算部分 -->
    <div class="section">
      <h2>变压器定值计算</h2>
      
      <!-- 变比系数及CT选项输入 -->
      <div class="input-group">
        <label>相序变比系数:</label>
        <input type="text" id="k3" value="120">
      </div>
      <div class="input-group">
        <label>零序变比系数:</label>
        <input type="text" id="k0" value="20">
      </div>
      <div class="input-group">
        <label>站出线（变电站）CT为600:</label>
        <select id="ctOption">
          <option value="no" selected>否</option>
          <option value="yes">是</option>
        </select>
      </div>
      
      <!-- 容量选择 -->
      <div class="capacity-grid" id="capacityInputs"></div>

      <!-- 修改按钮，增加不同颜色及间距 -->
      <button class="calc-button" onclick="calculate()">计算变压器定值</button>
      <button class="reset-button" onclick="resetCapacities()">清空已选容量</button>

      <!-- 计算结果显示 -->
      <div class="results" id="results" style="display: none">
        <div class="input-group">
          <label>负荷电流 (A):</label>
          <input type="text" id="loadCurrent" readonly>
        </div>
        <div class="input-group">
          <label>一段定值 (A):</label>
          <input type="text" id="firstProtection" readonly>
        </div>
        <div class="input-group">
          <label>二段定值 (A):</label>
          <input type="text" id="secondProtection" readonly>
        </div>
        <!-- 将一次侧提示文本放置在输入框后面，以红色显示 -->
        <div class="input-group">
          <label>一段定值 (A):</label>
          <input type="text" id="firstProtectionPrimary" readonly>
          <span style="color: red;">(一次值)</span>
        </div>
        <div class="input-group">
          <label>二段定值 (A):</label>
          <input type="text" id="secondProtectionPrimary" readonly>
          <span style="color: red;">(一次值)</span>
        </div>
        <div class="input-group">
          <label>零序定值 (A):</label>
          <input type="text" id="zeroSequence" readonly>
        </div>
        <div class="text-result" id="textResult"></div>
      </div>
    </div>

    <!-- 文字处理部分 -->
    <div class="section">
      <h2>文字提取处理</h2>
      <div class="input-group">
        <label>输入文字:</label>
        <input type="text" id="inputText" class="text-input" 
               placeholder="输入类似格式：10kV员热F29员村石东联社（科韵路）开关房G03柜603开关">
      </div>
      <button onclick="processText()">处理文字</button>
      <div class="text-results" id="textResults">
        <div class="result-item">
          <label>变电站名称:</label>
          <span id="result1"></span>
        </div>
        <div class="result-item">
          <label>馈线:</label>
          <span id="result2"></span>
        </div>
        <div class="result-item">
          <label>开关房:</label>
          <span id="result3"></span>
        </div>
        <div class="result-item">
          <label>开关名称:</label>
          <span id="result4"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 容量选项定义（在“变压器容量选填”后增加“电机容量填写（非盾构机）”选项）
    const capacityOptions = ['请选择', '30.5', '80', '100', '315', '500', '630', '800', 
                             '1000', '1250', '1600', '2000', '2500', '3000', '变压器容量选填', '电机容量填写（非盾构机）'];

    // 创建容量选择框
    function createCapacityInputs() {
      const container = document.getElementById('capacityInputs');
      for (let i = 0; i < 10; i++) {
        const div = document.createElement('div');
        div.className = 'input-group';

        const label = document.createElement('label');
        label.textContent = `容量（kVA） ${i + 1}:`;

        const select = document.createElement('select');
        select.id = `capacity${i}`;
        select.onchange = () => onCapacityChange(i);

        capacityOptions.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          select.appendChild(opt);
        });

        const customInput = document.createElement('input');
        customInput.type = 'text';
        customInput.id = `customCapacity${i}`;
        customInput.style.display = 'none';
        customInput.placeholder = '输入容量';

        div.appendChild(label);
        div.appendChild(select);
        div.appendChild(customInput);
        container.appendChild(div);
      }
    }

    // 当选择变化时，显示或隐藏自定义输入框
    function onCapacityChange(index) {
      const select = document.getElementById(`capacity${index}`);
      const customInput = document.getElementById(`customCapacity${index}`);
      customInput.style.display = (select.value === '变压器容量选填' || select.value === '电机容量填写（非盾构机）') ? 'inline-block' : 'none';
    }

    // 获取每个容量输入的值，并区分类型
    function getCapacityValue(index) {
      const select = document.getElementById(`capacity${index}`);
      const customInput = document.getElementById(`customCapacity${index}`);
      const selected = select.value;
      if (selected === '请选择') {
        return null;
      } else if (selected === '变压器容量选填') {
        const val = customInput.value.trim();
        return val ? { type: 'normal', value: parseFloat(val) } : null;
      } else if (selected === '电机容量填写（非盾构机）') {
        const val = customInput.value.trim();
        return val ? { type: 'motor', value: parseFloat(val) } : null;
      } else {
        return { type: 'normal', value: parseFloat(selected) };
      }
    }

    function calculate() {
      try {
        const k3 = parseFloat(document.getElementById('k3').value);
        const k0 = parseFloat(document.getElementById('k0').value);

        let normalCapacities = [];
        let motorCapacities = [];
        for (let i = 0; i < 10; i++) {
          const item = getCapacityValue(i);
          if (item) {
            if (item.type === 'normal') {
              normalCapacities.push(item.value);
            } else if (item.type === 'motor') {
              motorCapacities.push(item.value);
            }
          }
        }

        if (normalCapacities.length === 0 && motorCapacities.length === 0) {
          alert('请至少选择一个容量值');
          return;
        }

        const transformerLoadCurrent = normalCapacities.length > 0 ?
              normalCapacities.reduce((sum, cap) => sum + cap, 0) / (10.5 * 1.732) : 0;

        let firstProtection;
        if (normalCapacities.length > 0) {
          const maxNormal = Math.max(...normalCapacities);
          const countNormal = normalCapacities.length;
          const coefficient = countNormal <= 3 ? 25 : (countNormal <= 6 ? 30 : 35);
          firstProtection = Math.max(0.57, Math.min(((maxNormal * coefficient) / (10.5 * 1.732)), 2479) / k3);
        } else if (motorCapacities.length > 0) {
          const maxMotor = Math.max(...motorCapacities);
          const countMotor = motorCapacities.length;
          const coefficient = countMotor <= 3 ? 25 : (countMotor <= 6 ? 30 : 35);
          firstProtection = Math.max(0.57, Math.min(((maxMotor * coefficient) / (10.5 * 1.732)), 2479) / k3);
        }

        let motorLoadCurrent = 0;
        if (motorCapacities.length > 0) {
          if (motorCapacities.length === 1) {
            motorLoadCurrent = motorCapacities[0] * 9 / 100 * 8;
          } else {
            let sum = 0;
            for (let i = 0; i < motorCapacities.length - 1; i++) {
              sum += motorCapacities[i] * 9 / 100;
            }
            let lastMotor = motorCapacities[motorCapacities.length - 1] * 9 / 100 * 8;
            motorLoadCurrent = sum + lastMotor;
          }
        }

        let loadCurrentForSecond;
        if (normalCapacities.length > 0 && motorCapacities.length > 0) {
          loadCurrentForSecond = (transformerLoadCurrent + motorLoadCurrent) * 1.3;
        } else if (motorCapacities.length > 0) {
          loadCurrentForSecond = motorLoadCurrent * 1.3;
        } else {
          loadCurrentForSecond = transformerLoadCurrent;
        }

        let secondProtection;
        if (loadCurrentForSecond > 548) {
          secondProtection = 1040 * 0.82 / k3;
        } else {
          const baseValue = Math.min(1.56 * loadCurrentForSecond, 630) / k3;
          let minCapacity;
          if (normalCapacities.length > 0) {
            minCapacity = Math.min(...normalCapacities);
          } else if (motorCapacities.length > 0) {
            minCapacity = Math.min(...motorCapacities);
          }
          let capacityBased;
          if (minCapacity < 315) {
            capacityBased = 8 * minCapacity / (10.5 * 1.732 * k3);
          } else if (minCapacity === 315) {
            capacityBased = 150 / k3;
          } else if (minCapacity === 400) {
            capacityBased = 190 / k3;
          } else if (minCapacity === 500) {
            capacityBased = 220 / k3;
          } else if (minCapacity === 630) {
            capacityBased = 260 / k3;
          } else if (minCapacity === 800) {
            capacityBased = 310 / k3;
          } else if (minCapacity > 2000) {
            capacityBased = 5 * minCapacity / (10.5 * 1.732 * k3);
          } else {
            capacityBased = 6 * minCapacity / (10.5 * 1.732 * k3);
          }
          secondProtection = Math.max(0.18, Math.max(baseValue, capacityBased));
        }
        
        // 若选择涉及变电站CT为600，则二段定值最大限定为5.33A
        const ctOption = document.getElementById('ctOption').value;
        if (ctOption === 'yes' && secondProtection > 5.33) {
          secondProtection = 5.33;
        }

        // 保证一级定值至少为二级定值的1.1倍
        if (firstProtection < secondProtection * 1.1) {
          firstProtection = secondProtection * 1.1;
        }

        // 计算一次侧定值（原先数字 * 相序变比系数）
        const firstProtectionPrimary = firstProtection * k3;
        const secondProtectionPrimary = secondProtection * k3;

        const zeroSequence = 2.25 / k0 * 20;

        // 更新显示结果
        document.getElementById('loadCurrent').value = loadCurrentForSecond.toFixed(2);
        document.getElementById('firstProtection').value = firstProtection.toFixed(2);
        document.getElementById('secondProtection').value = secondProtection.toFixed(2);
        document.getElementById('firstProtectionPrimary').value = firstProtectionPrimary.toFixed(2);
        document.getElementById('secondProtectionPrimary').value = secondProtectionPrimary.toFixed(2);
        document.getElementById('zeroSequence').value = zeroSequence.toFixed(2);
        document.getElementById('textResult').textContent =
          `一段${firstProtection.toFixed(2)}A 0.05秒  二段${secondProtection.toFixed(2)}A 0.3秒  零序${zeroSequence.toFixed(2)}A 0.4秒`;
        document.getElementById('results').style.display = 'block';

        // 如果负荷电流大于853.2，则添加红色警告信息
        let warningElem = document.getElementById('warningMessage');
        if (warningElem) {
          warningElem.parentNode.removeChild(warningElem);
        }
        if (loadCurrentForSecond > 853.2) {
          warningElem = document.createElement('p');
          warningElem.id = 'warningMessage';
          warningElem.textContent = '负荷电流已达最大值，计算结果将不适用，建议考虑专线';
          warningElem.style.color = 'red';
          document.getElementById('results').appendChild(warningElem);
        }
      } catch (error) {
        alert('计算出错：' + error.message);
      }
    }

    function resetCapacities() {
      for (let i = 0; i < 10; i++) {
        const select = document.getElementById(`capacity${i}`);
        const customInput = document.getElementById(`customCapacity${i}`);
        select.value = '请选择';
        customInput.value = '';
        customInput.style.display = 'none';
      }
    }

    function processText() {
      const text = document.getElementById('inputText').value;
      try {
        const result1 = text.substring(
          text.indexOf('10kV') + '10kV'.length,
          text.indexOf('F')
        ).trim();
        let result2 = result1;
        const fIndex = text.indexOf('F');
        if (fIndex !== -1) {
          const nextChar = text.charAt(fIndex + 2);
          const fPart = text.substring(fIndex, fIndex + (isNaN(nextChar) ? 2 : 3));
          result2 += fPart;
        }
        const result3 = text.substring(0, text.indexOf('G')).trim();
        const fStartIndex = text.indexOf('F');
        const fLength = isNaN(text.charAt(fStartIndex + 2)) ? 2 : 3;
        const result4 = text.substring(fStartIndex + fLength).trim();

        document.getElementById('result1').textContent = result1;
        document.getElementById('result2').textContent = result2;
        document.getElementById('result3').textContent = result3;
        document.getElementById('result4').textContent = result4;
        document.getElementById('textResults').style.display = 'block';
      } catch (error) {
        alert('处理文字时出错：' + error.message);
      }
    }

    createCapacityInputs();
  </script>
</body>
</html>
