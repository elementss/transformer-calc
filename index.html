<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>变压器继保定值计算器 v6.0</title>
  <style>
    /* CSS 变量定义 - 现代化配色方案 */
    :root {
      --primary-color: #5B5FDE;
      --primary-hover: #4A4ECC;
      --primary-light: #E8E9FF;
      --secondary-color: #6C757D;
      --success-color: #10B981;
      --success-light: #D1FAE5;
      --danger-color: #EF4444;
      --danger-light: #FEE2E2;
      --warning-color: #F59E0B;
      --warning-light: #FEF3C7;
      --info-color: #3B82F6;
      --info-light: #DBEAFE;
      
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: #FFFFFF;
      --bg-color: #F8F9FB;
      --border-color: #E5E7EB;
      --text-color: #1F2937;
      --text-secondary: #6B7280;
      --text-light: #9CA3AF;
      
      --radius-sm: 6px;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 暗色主题 */
    @media (prefers-color-scheme: dark) {
      :root {
        --card-bg: #1F2937;
        --bg-color: #111827;
        --border-color: #374151;
        --text-color: #F9FAFB;
        --text-secondary: #D1D5DB;
        --text-light: #9CA3AF;
        --primary-light: #312E81;
        --success-light: #064E3B;
        --danger-light: #7F1D1D;
        --warning-light: #78350F;
        --info-light: #1E3A8A;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* 背景装饰 */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 300px;
      background: var(--bg-gradient);
      z-index: -1;
      opacity: 0.1;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 头部设计 */
    .header {
      text-align: center;
      padding: 40px 20px;
      margin-bottom: 40px;
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: var(--bg-gradient);
      border-radius: 2px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version-info {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-top: 10px;
    }

    .version-info p {
      margin: 5px 0;
    }

    /* 标签页设计 */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 8px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .tab {
      flex: 1;
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--primary-color);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      opacity: 0.1;
    }

    .tab:hover {
      color: var(--primary-color);
      background: var(--primary-light);
    }

    .tab:hover::before {
      width: 100%;
      height: 100%;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 卡片设计 */
    .section {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .section:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-color);
    }

    .section-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-light);
      border-radius: var(--radius);
      font-size: 1.25rem;
    }

    /* 输入组设计 */
    .input-group {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    label {
      min-width: 150px;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input, select {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.875rem;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(91, 95, 222, 0.1);
    }

    input[readonly] {
      background-color: var(--bg-color);
      cursor: not-allowed;
      opacity: 0.7;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-family: 'Consolas', 'Monaco', monospace;
      resize: vertical;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(91, 95, 222, 0.1);
    }

    /* 按钮设计 */
    .button-group {
      display: flex;
      gap: 12px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #DC2626;
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #4B5563;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background: #D97706;
    }

    /* 容量选择器设计 */
    .capacity-container {
      margin: 25px 0;
      padding: 20px;
      background: var(--bg-color);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }

    .capacity-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .capacity-count {
      padding: 8px 16px;
      background: var(--primary-light);
      color: var(--primary-color);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    #selectedList {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #selectedList > div {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--info-light);
      color: var(--info-color);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #selectedList button {
      margin-left: 8px;
      background: none;
      border: none;
      color: var(--info-color);
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }

    #selectedList button:hover {
      background: var(--info-color);
      color: white;
      transform: scale(1.1);
    }

    /* 结果显示设计 */
    .results {
      margin-top: 30px;
      padding: 30px;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--card-bg) 100%);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .result-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .result-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .result-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .primary-value {
      color: var(--danger-color);
    }

    .text-result {
      padding: 20px;
      background: var(--info-light);
      border-left: 4px solid var(--info-color);
      border-radius: var(--radius);
      font-size: 1rem;
      line-height: 1.8;
      margin-top: 20px;
    }

    /* 消息提示设计 */
    .warning-message, .error-message, .success-message {
      margin-top: 20px;
      padding: 16px 20px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .warning-message {
      background: var(--warning-light);
      color: var(--warning-color);
      border: 1px solid var(--warning-color);
    }

    .error-message {
      background: var(--danger-light);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }

    .success-message {
      background: var(--success-light);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }

    /* 批量预览设计 */
    .batch-preview {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      padding: 15px;
      background: var(--bg-color);
    }

    .batch-item {
      padding: 15px;
      margin-bottom: 12px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .batch-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    .batch-item.error {
      border-color: var(--danger-color);
      background: var(--danger-light);
    }

    .batch-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .batch-item-details {
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    /* 统计信息设计 */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .stat-item {
      text-align: center;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .stat-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* 工具提示 */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background: var(--text-color);
      color: var(--card-bg);
      text-align: center;
      border-radius: var(--radius);
      padding: 8px 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
      box-shadow: var(--shadow-lg);
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--text-color) transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* 文字处理结果 */
    .text-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .text-result-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .text-result-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    .text-result-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .text-result-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    /* 模态框设计 */
    #capacityModal {
      backdrop-filter: blur(5px);
    }

    #capacityModal > div {
      background: var(--card-bg);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translate(-50%, -45%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    #capacityOptions > div {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    #capacityOptions button {
      padding: 12px;
      font-size: 0.875rem;
    }

    /* 批量结果设计 */
    .batch-result-item {
      margin-bottom: 25px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .batch-result-item:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .batch-result-header {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .batch-result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    /* 加载动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        width: 100%;
      }
      
      .input-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      label {
        width: 100%;
      }
      
      input, select {
        width: 100%;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
      
      .result-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 打印样式 */
    @media print {
      body {
        background: white;
      }
      
      body::before {
        display: none;
      }
      
      .button-group, .tabs {
        display: none;
      }
      
      .section {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>变压器继保定值计算器</h1>
      <div class="version-info">
        <p>版本 6.0 | 250702 | 核心重构，全新UI设计</p>
        <p>开发者：韩翰 | 反馈邮箱：icevivi8@gmail.com</p>
      </div>
    </div>

    <!-- 标签页导航 -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('single', this)">
        <span>⚡ 单个计算</span>
      </button>
      <button class="tab" onclick="switchTab('batch', this)">
        <span>📊 批量计算</span>
      </button>
      <button class="tab" onclick="switchTab('text', this)">
        <span>📝 文字处理</span>
      </button>
    </div>

    <!-- 单个计算标签页 -->
    <div id="single-tab" class="tab-content active">
      <div class="section">
        <h2>
          <span class="section-icon">⚡</span>
          变压器定值计算
        </h2>
        
        <!-- 基本参数设置 -->
        <div class="parameters-group">
          <div class="input-group">
            <label>🏷️ 开关名称</label>
            <input type="text" id="switchName" placeholder="请输入开关名称">
          </div>
          <div class="input-group">
            <label>🔄 相序变比</label>
            <input type="text" id="k3" value="600/5" placeholder="例如：600/5">
            <span class="tooltip">❓
              <span class="tooltiptext">相序CT变比，格式：XX/5</span>
            </span>
          </div>
          <div class="input-group">
            <label>⭕ 零序变比</label>
            <input type="text" id="k0" value="100/5" placeholder="例如：100/5">
            <span class="tooltip">❓
              <span class="tooltiptext">零序CT变比，格式：XX/5</span>
            </span>
          </div>
          <div class="input-group">
            <label>📊 站出线CT规格</label>
            <select id="ctOption">
              <option value="no" selected>标准</option>
              <option value="yes">600A (变电站)</option>
            </select>
          </div>
        </div>
        
        <!-- 容量选择区域 -->
        <div class="capacity-container">
          <div class="capacity-controls">
            <button class="btn-secondary" onclick="showCapacitySelector()">
              ➕ 添加容量
            </button>
            <span class="capacity-count" id="capacityCount">已选择 0 个容量</span>
          </div>
          <div id="selectedCapacities" style="display: none;">
            <h3 style="font-size: 1rem; margin-bottom: 15px; color: var(--text-secondary);">已选容量列表：</h3>
            <div id="selectedList"></div>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="button-group">
          <button class="btn-primary" onclick="calculate()">
            📊 计算变压器定值
          </button>
          <button class="btn-danger" onclick="resetCapacities()">
            🗑️ 清空已选容量
          </button>
          <button class="btn-secondary" onclick="exportResults()">
            📥 导出结果
          </button>
        </div>

        <!-- 计算结果显示 -->
        <div class="results" id="results" style="display: none">
          <h3 style="margin-top: 0; color: var(--primary-color);">计算结果</h3>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">负荷电流</div>
              <div class="result-value" id="loadCurrent">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">一段定值（二次值）</div>
              <div class="result-value" id="firstProtection">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">二段定值（二次值）</div>
              <div class="result-value" id="secondProtection">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">一段定值（一次值）</div>
              <div class="result-value primary-value" id="firstProtectionPrimary">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">二段定值（一次值）</div>
              <div class="result-value primary-value" id="secondProtectionPrimary">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">零序定值</div>
              <div class="result-value" id="zeroSequence">-</div>
            </div>
          </div>
          <div class="text-result" id="textResult"></div>
          <div id="warningContainer"></div>
        </div>
      </div>
    </div>

    <!-- 批量计算标签页 -->
    <div id="batch-tab" class="tab-content">
      <div class="section">
        <h2>
          <span class="section-icon">📋</span>
          批量计算
        </h2>
        
        <div class="input-group">
          <label style="width: 100%; margin-bottom: 10px;">📝 粘贴批量数据（支持自动识别格式）</label>
        </div>
        <textarea id="batchInput" placeholder="请粘贴批量数据，系统将自动识别以下信息：
- 开关名称
- 变压器容量（支持kVA格式，支持多台相加如：1250kVA+1250kVA）
- 相序CT变比
- 零序CT变比

系统支持多种数据格式：
1. 带序号的格式（1、2、3...）
2. 逗号分隔的格式
3. 项目名称开头的格式
4. 自由文本格式

示例：
项目名称：xxx项目
开关名称：珠江花城2号开关房G01柜601开关
开关后段变压器容量：630kVA
相序CT变比：600/5 10P20级
零序CT变比：100/5 10P10级"></textarea>

        <div class="button-group">
          <button class="btn-primary" onclick="parseBatchData()">
            🔍 解析数据
          </button>
          <button class="btn-success" onclick="calculateBatch()" id="batchCalculateBtn" disabled>
            📊 批量计算
          </button>
          <button class="btn-danger" onclick="clearBatchData()">
            🗑️ 清空数据
          </button>
          <button class="btn-secondary" onclick="exportBatchResults()" id="exportBatchBtn" disabled>
            📥 导出全部结果
          </button>
          <button class="btn-warning" onclick="loadSampleData()">
            📝 加载示例数据
          </button>
        </div>

        <!-- 解析预览 -->
        <div id="batchPreview" style="display: none;">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">解析结果预览</h3>
          <div class="stats-container" id="batchStats"></div>
          <div class="batch-preview" id="batchPreviewContent"></div>
        </div>

        <!-- 批量计算结果 -->
        <div id="batchResults" class="batch-results" style="display: none;">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">批量计算结果</h3>
          <div class="button-group">
            <button class="btn-secondary" onclick="copyAllResults()">
              📋 复制所有结果
            </button>
            <button class="btn-primary" onclick="printBatchResults()">
              🖨️ 打印结果
            </button>
          </div>
          <div id="batchResultsContent"></div>
        </div>
      </div>
    </div>

    <!-- 文字处理标签页 -->
    <div id="text-tab" class="tab-content">
      <div class="section">
        <h2>
          <span class="section-icon">📝</span>
          文字提取处理
        </h2>
        <div class="input-group">
          <label>📝 输入文字</label>
          <input type="text" id="inputText" style="flex: 1;"
                 placeholder="例如：10kV员热F29员村石东联社（科韵路）开关房G03柜603开关">
        </div>
        <div class="button-group">
          <button class="btn-success" onclick="processText()">
            🔍 处理文字
          </button>
          <button class="btn-secondary" onclick="clearTextResults()">
            🗑️ 清空结果
          </button>
        </div>
        <div class="text-results" id="textResults" style="display: none;">
          <div class="text-result-item">
            <div class="text-result-label">变电站名称</div>
            <div class="text-result-value" id="result1">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">馈线</div>
            <div class="text-result-value" id="result2">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">开关房</div>
            <div class="text-result-value" id="result3">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">开关名称</div>
            <div class="text-result-value" id="result4">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 容量选择模态框 -->
  <div id="capacityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      <h3 style="margin-bottom: 25px; color: var(--primary-color); font-size: 1.5rem;">选择容量</h3>
      <div style="margin: 25px 0;">
        <label style="margin-right: 15px; font-weight: 600;">容量类型：</label>
        <select id="capacityType" onchange="updateCapacityOptions()" style="padding: 10px 20px; border-radius: var(--radius); border: 2px solid var(--border-color);">
          <option value="transformer">变压器容量 (kVA)</option>
          <option value="motor">电机容量 (kW)</option>
          <option value="custom">自定义容量</option>
        </select>
      </div>
      <div id="capacityOptions" style="margin: 25px 0;"></div>
      <div class="button-group" style="justify-content: center; margin-top: 30px;">
        <button class="btn-primary" onclick="addSelectedCapacity()">确定</button>
        <button class="btn-secondary" onclick="closeCapacityModal()">取消</button>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let selectedCapacities = [];
    let batchData = [];
    let batchCalculationResults = [];
    const transformerCapacities = [30.5, 80, 100, 200, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3000];
    const motorCapacities = [5.5, 7.5, 11, 15, 18.5, 22, 30, 37, 45, 55, 75, 90, 110, 132, 160, 200, 250, 315];

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      updateCapacityDisplay();
    });

    // 标签页切换
    function switchTab(tabName, element) {
      // 移除所有活动状态
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // 激活选中的标签页
      element.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // 加载示例数据
    function loadSampleData() {
      const sampleData = `项目名称：广州市天河区珠吉街吉山第二股份合作经济社业扩配套项目
电房名称：珠江花城2号开关房
开关名称：珠江花城2号开关房G01柜601开关
开关后段变压器容量：630kVA
断路器柜厂家名称：穂达
微机厂家名称：珠海科众
相序CT变比：600/5 10P20级
零序CT变比：100/5 10P10级
送电时间：2025年07月16日
申请原因：新投运

，1、项目名称：天河区高普路68号地块10kV供电设施迁改项目（临迁）
电房名称：10kV高塘F10高普路68号开关房
开关名称：10kV高塘F10高普路68号开关房G04柜
开关后段变压器容量：1250kVA+1250kVA
断路器柜厂家名称：希格玛电气（珠海）有限公司
微机厂家名称：珠海万力达电气技术股份有限公司
相序CT变比：600/5 10P10
零序CT变比：100/5 10P10
送电时间：2025.06.26
申请原因：新投产`;
      
      document.getElementById('batchInput').value = sampleData;
    }

    // 解析批量数据
    function parseBatchData() {
      const input = document.getElementById('batchInput').value.trim();
      if (!input) {
        alert('请输入批量数据');
        return;
      }

      batchData = [];
      
      // 智能分割数据项 - 支持多种分隔方式
      let items = [];
      
      // 首先移除可能的干扰文本（如 @提及）
      let cleanInput = input.replace(/@[\u4e00-\u9fa5\w\s]+/g, '');
      
      // 尝试按数字序号分割（如：1、2、等）
      if (cleanInput.match(/\d+[、.]\s*项目名称/)) {
        items = cleanInput.split(/(?=\d+[、.]\s*项目名称)/);
      }
      // 尝试按"项目名称"分割（但需要确保是独立的项目开始）
      else if (cleanInput.includes('项目名称')) {
        // 使用更精确的分割方式，避免错误分割
        items = cleanInput.split(/(?=项目名称[：:])/).filter((item, index) => {
          // 过滤掉第一个空项
          if (index === 0 && !item.trim()) return false;
          // 确保包含必要的字段
          return item.includes('开关名称') && item.includes('变压器容量');
        });
      }
      // 尝试按逗号和换行符组合分割
      else if (cleanInput.includes('，') && cleanInput.includes('开关名称')) {
        items = cleanInput.split(/[，,]\s*(?=\d+[、.]|项目名称)/);
      }
      // 尝试按双换行符分割
      else {
        items = cleanInput.split(/\n\s*\n/);
      }
      
      items = items.filter(item => item.trim() && item.length > 50); // 过滤太短的项
      
      items.forEach((item, index) => {
        const data = {
          index: index + 1,
          rawText: item,
          parsed: {}
        };

        // 智能解析各字段
        
        // 1. 解析开关名称 - 支持多种格式
        const switchNamePatterns = [
          /开关名称[：:]\s*([^\n]+?)(?=\n|$)/,
          /开关名称[：:]\s*(.+?)(?=开关后段|断路器|微机|相序|零序|送电|申请|$)/
        ];
        
        for (let pattern of switchNamePatterns) {
          const match = item.match(pattern);
          if (match) {
            data.parsed.switchName = match[1].trim();
            break;
          }
        }
        
        // 2. 解析变压器容量 - 支持多台变压器
        const capacityPatterns = [
          /变压器容量[：:]\s*(.+?)(?=\n|断路器|微机|相序|零序|送电|申请|$)/,
          /(\d+(?:\.\d+)?\s*kVA(?:\s*[+＋]\s*\d+(?:\.\d+)?\s*kVA)*)/i
        ];
        
        for (let pattern of capacityPatterns) {
          const match = item.match(pattern);
          if (match) {
            const capacityStr = match[1];
            // 处理多台变压器的情况
            if (capacityStr.includes('+') || capacityStr.includes('＋')) {
              const capacities = capacityStr.match(/\d+(?:\.\d+)?/g);
              if (capacities) {
                // 保存多台变压器的容量数组
                data.parsed.capacities = capacities.map(cap => parseFloat(cap));
                data.parsed.capacityUnit = 'kVA';
                data.parsed.isMultiple = true;
                data.parsed.capacityNote = `${capacities.length}台变压器：${capacityStr}`;
                // 用于显示，但不用于计算
                data.parsed.capacity = data.parsed.capacities[0]; // 使用第一台的容量显示
              }
            } else {
              const singleCapMatch = capacityStr.match(/(\d+(?:\.\d+)?)\s*kVA/i);
              if (singleCapMatch) {
                data.parsed.capacity = parseFloat(singleCapMatch[1]);
                data.parsed.capacityUnit = 'kVA';
                data.parsed.isMultiple = false;
                data.parsed.capacities = [parseFloat(singleCapMatch[1])]; // 确保单台也有capacities数组
              }
            }
            break;
          }
        }
        
        // 3. 解析相序CT变比 - 支持多种格式
        const k3Patterns = [
          /相序CT变比[：:]\s*(\d+)\s*\/\s*(\d+)/,
          /相序CT[：:]\s*(\d+)\s*\/\s*(\d+)/,
          /相序变比[：:]\s*(\d+)\s*\/\s*(\d+)/
        ];
        
        for (let pattern of k3Patterns) {
          const match = item.match(pattern);
          if (match) {
            data.parsed.k3 = `${match[1]}/${match[2]}`;
            break;
          }
        }
        
        // 4. 解析零序CT变比 - 支持多种格式
        const k0Patterns = [
          /零序CT变比[：:]\s*(\d+)\s*\/\s*(\d+)/,
          /零序CT[：:]\s*(\d+)\s*\/\s*(\d+)/,
          /零序变比[：:]\s*(\d+)\s*\/\s*(\d+)/
        ];
        
        for (let pattern of k0Patterns) {
          const match = item.match(pattern);
          if (match) {
            data.parsed.k0 = `${match[1]}/${match[2]}`;
            break;
          }
        }
        
        // 5. 提取其他有用信息
        // 项目名称
        const projectMatch = item.match(/项目名称[：:]\s*(.+?)(?=\n|电房|$)/);
        if (projectMatch) {
          data.parsed.projectName = projectMatch[1].trim();
        }
        
        // 电房名称
        const roomMatch = item.match(/电房名称[：:]\s*(.+?)(?=\n|开关名称|$)/);
        if (roomMatch) {
          data.parsed.roomName = roomMatch[1].trim();
        }
        
        // 送电时间
        const dateMatch = item.match(/送电时间[：:]\s*(.+?)(?=\n|申请|$)/);
        if (dateMatch) {
          data.parsed.powerOnDate = dateMatch[1].trim();
        }

        // 检查必要字段
        if (data.parsed.switchName && data.parsed.capacity && data.parsed.k3 && data.parsed.k0) {
          data.status = 'success';
        } else {
          data.status = 'error';
          const missingFields = [];
          if (!data.parsed.switchName) missingFields.push('开关名称');
          if (!data.parsed.capacity) missingFields.push('变压器容量');
          if (!data.parsed.k3) missingFields.push('相序CT变比');
          if (!data.parsed.k0) missingFields.push('零序CT变比');
          data.error = `缺少字段：${missingFields.join('、')}`;
        }

        batchData.push(data);
      });

      // 显示解析结果
      displayBatchPreview();
    }

    // 显示批量数据预览
    function displayBatchPreview() {
      const previewContainer = document.getElementById('batchPreview');
      const previewContent = document.getElementById('batchPreviewContent');
      const statsContainer = document.getElementById('batchStats');
      
      // 统计信息
      const successCount = batchData.filter(d => d.status === 'success').length;
      const errorCount = batchData.filter(d => d.status === 'error').length;
      
      statsContainer.innerHTML = `
        <div class="stat-item">
          <div class="stat-value">${batchData.length}</div>
          <div class="stat-label">总数据条数</div>
        </div>
        <div class="stat-item" style="background: var(--success-light);">
          <div class="stat-value" style="color: var(--success-color);">${successCount}</div>
          <div class="stat-label">解析成功</div>
        </div>
        <div class="stat-item" style="background: var(--danger-light);">
          <div class="stat-value" style="color: var(--danger-color);">${errorCount}</div>
          <div class="stat-label">解析失败</div>
        </div>
      `;
      
      // 预览内容
      previewContent.innerHTML = '';
      batchData.forEach(data => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `batch-item ${data.status === 'error' ? 'error' : ''}`;
        
        if (data.status === 'success') {
          const capacityDisplay = data.parsed.isMultiple && data.parsed.capacities 
            ? `${data.parsed.capacities.join('+')} ${data.parsed.capacityUnit}` 
            : `${data.parsed.capacity} ${data.parsed.capacityUnit}`;
            
          itemDiv.innerHTML = `
            <div class="batch-item-header">
              <span>序号 ${data.index}: ${data.parsed.switchName}</span>
              <span style="color: var(--success-color);">✓</span>
            </div>
            <div class="batch-item-details">
              <div>容量: ${capacityDisplay} ${data.parsed.capacityNote ? `(${data.parsed.capacityNote})` : ''}</div>
              <div>相序变比: ${data.parsed.k3}</div>
              <div>零序变比: ${data.parsed.k0}</div>
              ${data.parsed.projectName ? `<div>项目: ${data.parsed.projectName}</div>` : ''}
              ${data.parsed.powerOnDate ? `<div>送电时间: ${data.parsed.powerOnDate}</div>` : ''}
            </div>
          `;
        } else {
          itemDiv.innerHTML = `
            <div class="batch-item-header">
              <span>序号 ${data.index}</span>
              <span style="color: var(--danger-color);">✗ ${data.error}</span>
            </div>
            <div class="batch-item-details" style="color: var(--danger-color);">
              ${data.rawText.substring(0, 100)}...
            </div>
          `;
        }
        
        previewContent.appendChild(itemDiv);
      });
      
      previewContainer.style.display = 'block';
      
      // 启用/禁用批量计算按钮
      document.getElementById('batchCalculateBtn').disabled = successCount === 0;
    }

    // 批量计算
    function calculateBatch() {
      batchCalculationResults = [];
      const successData = batchData.filter(d => d.status === 'success');
      
      successData.forEach(data => {
        let capacities;
        
        // 判断是否为多台变压器
        if (data.parsed.isMultiple && data.parsed.capacities) {
          // 多台变压器，每台都作为独立的容量
          capacities = data.parsed.capacities.map(cap => ({ type: 'transformer', value: cap }));
        } else {
          // 单台变压器
          capacities = [{ type: 'transformer', value: data.parsed.capacity }];
        }
        
        const result = calculateSingle(
          data.parsed.switchName,
          data.parsed.k3,
          data.parsed.k0,
          capacities,
          'no' // 默认使用标准CT
        );
        
        batchCalculationResults.push({
          ...data,
          calculation: result
        });
      });
      
      displayBatchResults();
    }

    // 单个计算核心函数
    function calculateSingle(switchName, k3Input, k0Input, capacities, ctOption) {
      const k3 = parseRatio(k3Input);
      const k0 = parseRatio(k0Input);

      if (!k3 || !k0 || k3 <= 0 || k0 <= 0) {
        return null;
      }

      const transformerCaps = capacities.filter(c => c.type === 'transformer').map(c => c.value);
      const motorCaps = capacities.filter(c => c.type === 'motor').map(c => c.value);

      // 计算变压器负荷电流
      const transformerLoadCurrent = transformerCaps.length > 0 ?
            transformerCaps.reduce((sum, cap) => sum + cap, 0) / (10.5 * 1.732) : 0;

      // 计算一段保护定值
      let firstProtection = 0;
      if (transformerCaps.length > 0) {
        const maxNormal = Math.max(...transformerCaps);
        const countNormal = transformerCaps.length;
        const coefficient = countNormal <= 3 ? 25 : (countNormal <= 6 ? 30 : 35);
        const firstProtectionCalc = (maxNormal * coefficient) / (10.5 * 1.732);
        firstProtection = Math.max(0.57, Math.min(firstProtectionCalc, 2479) / k3);
      } else if (motorCaps.length > 0) {
        const maxMotor = Math.max(...motorCaps);
        const countMotor = motorCaps.length;
        const coefficient = countMotor <= 3 ? 25 : (countMotor <= 6 ? 30 : 35);
        const firstProtectionCalc = (maxMotor * coefficient) / (10.5 * 1.732);
        firstProtection = Math.max(0.57, Math.min(firstProtectionCalc, 2479) / k3);
      }

      // 计算电机负荷电流
      let motorLoadCurrent = 0;
      if (motorCaps.length > 0) {
        if (motorCaps.length === 1) {
          motorLoadCurrent = motorCaps[0] * 9 / 100 * 8;
        } else {
          let sum = 0;
          for (let i = 0; i < motorCaps.length - 1; i++) {
            sum += motorCaps[i] * 9 / 100;
          }
          let lastMotor = motorCaps[motorCaps.length - 1] * 9 / 100 * 8;
          motorLoadCurrent = sum + lastMotor;
        }
      }

      // 计算二段保护用负荷电流
      let loadCurrentForSecond;
      if (transformerCaps.length > 0 && motorCaps.length > 0) {
        loadCurrentForSecond = (transformerLoadCurrent + motorLoadCurrent) * 1.3;
      } else if (motorCaps.length > 0) {
        loadCurrentForSecond = motorLoadCurrent * 1.3;
      } else {
        loadCurrentForSecond = transformerLoadCurrent;
      }

      // 计算二段保护定值
      let secondProtection;
      if (loadCurrentForSecond > 548) {
        secondProtection = 1040 * 0.82 / k3;
      } else {
        const baseValue = Math.max(1.56 * loadCurrentForSecond, 0.1) / k3;
        let minCapacity;
        if (transformerCaps.length > 0) {
          minCapacity = Math.min(...transformerCaps);
        } else if (motorCaps.length > 0) {
          minCapacity = Math.min(...motorCaps);
        }
        
        let capacityBased;
        if (minCapacity < 315) {
          capacityBased = 8 * minCapacity / (10.5 * 1.732 * k3);
        } else {
          const capacityMap = {
            315: 150, 400: 190, 500: 220, 630: 260, 800: 310
          };
          if (capacityMap[minCapacity]) {
            capacityBased = capacityMap[minCapacity] / k3;
          } else if (minCapacity > 2000) {
            capacityBased = 5 * minCapacity / (10.5 * 1.732 * k3);
          } else {
            capacityBased = 6 * minCapacity / (10.5 * 1.732 * k3);
          }
        }
        secondProtection = Math.max(0.18, Math.max(baseValue, capacityBased));
      }
      
      // CT选项处理
      if (ctOption === 'yes' && secondProtection > 5.33) {
        secondProtection = 5.33;
      }

      // 确保一段定值大于二段定值的1.1倍
      if (firstProtection < secondProtection * 1.1) {
        firstProtection = secondProtection * 1.1;
      }

      // 计算一次值
      const firstProtectionPrimary = firstProtection * k3;
      const secondProtectionPrimary = secondProtection * k3;

      // 计算零序定值
      const zeroSequence = 2.25 / k0 * 20;

      return {
        loadCurrent: loadCurrentForSecond,
        firstProtection: firstProtection,
        secondProtection: secondProtection,
        firstProtectionPrimary: firstProtectionPrimary,
        secondProtectionPrimary: secondProtectionPrimary,
        zeroSequence: zeroSequence,
        warning: loadCurrentForSecond > 853.2
      };
    }

    // 显示批量计算结果
    function displayBatchResults() {
      const resultsContainer = document.getElementById('batchResults');
      const resultsContent = document.getElementById('batchResultsContent');
      
      resultsContent.innerHTML = '';
      
      batchCalculationResults.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'batch-result-item';
        
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}：` : '';
        
        // 容量显示处理
        const capacityDisplay = result.parsed.isMultiple && result.parsed.capacities 
          ? `${result.parsed.capacities.join('+')} ${result.parsed.capacityUnit}` 
          : `${result.parsed.capacity} ${result.parsed.capacityUnit}`;
        
        resultDiv.innerHTML = `
          <div class="batch-result-header">
            <span>📊</span>
            序号 ${result.index}: ${result.parsed.switchName}
          </div>
          <div class="batch-result-grid">
            <div>
              <div class="result-label">容量</div>
              <div style="font-weight: bold;">${capacityDisplay}</div>
            </div>
            <div>
              <div class="result-label">负荷电流</div>
              <div style="font-weight: bold;">${calc.loadCurrent.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">一段定值（二次值）</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.firstProtection.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">二段定值（二次值）</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.secondProtection.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">零序定值</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.zeroSequence.toFixed(2)} A</div>
            </div>
          </div>
          <div class="text-result">
            <strong>定值配置建议：</strong>${switchPrefix}一段 ${calc.firstProtection.toFixed(2)}A 0.05秒  二段 ${calc.secondProtection.toFixed(2)}A 0.3秒  零序 ${calc.zeroSequence.toFixed(2)}A 0.4秒
          </div>
          ${calc.warning ? '<div class="warning-message"><span>⚠️</span><span>负荷电流超过最大值，建议考虑专线供电方案。</span></div>' : ''}
        `;
        
        resultsContent.appendChild(resultDiv);
      });
      
      resultsContainer.style.display = 'block';
      document.getElementById('exportBatchBtn').disabled = false;
      
      // 滚动到结果区域
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 导出批量结果
    function exportBatchResults() {
      if (batchCalculationResults.length === 0) {
        alert('请先进行批量计算');
        return;
      }
      
      let exportText = `变压器继保定值批量计算结果
=====================================
计算时间：${new Date().toLocaleString()}
计算数量：${batchCalculationResults.length} 条

`;
      
      batchCalculationResults.forEach(result => {
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}：` : '';
        
        // 容量显示处理
        const capacityDisplay = result.parsed.isMultiple && result.parsed.capacities 
          ? `${result.parsed.capacities.join('+')} ${result.parsed.capacityUnit}` 
          : `${result.parsed.capacity} ${result.parsed.capacityUnit}`;
        
        exportText += `
【序号 ${result.index}】
开关名称：${result.parsed.switchName}
容量：${capacityDisplay}${result.parsed.capacityNote ? ` (${result.parsed.capacityNote})` : ''}
相序变比：${result.parsed.k3}
零序变比：${result.parsed.k0}

计算结果：
负荷电流：${calc.loadCurrent.toFixed(2)} A
一段定值（二次值）：${calc.firstProtection.toFixed(2)} A
二段定值（二次值）：${calc.secondProtection.toFixed(2)} A
一段定值（一次值）：${calc.firstProtectionPrimary.toFixed(2)} A
二段定值（一次值）：${calc.secondProtectionPrimary.toFixed(2)} A
零序定值：${calc.zeroSequence.toFixed(2)} A

定值配置建议：${switchPrefix}一段 ${calc.firstProtection.toFixed(2)}A 0.05秒  二段 ${calc.secondProtection.toFixed(2)}A 0.3秒  零序 ${calc.zeroSequence.toFixed(2)}A 0.4秒
${calc.warning ? '\n⚠️ 警告：负荷电流超过最大值，建议考虑专线供电方案。' : ''}
=====================================
`;
      });
      
      exportText += `
变压器继保定值计算器 v6.0
开发者：韩翰`;
      
      // 创建并下载文件
      const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `批量定值计算_${new Date().getTime()}.txt`;
      link.click();
    }

    // 复制所有结果
    function copyAllResults() {
      if (batchCalculationResults.length === 0) {
        alert('没有可复制的结果');
        return;
      }
      
      let copyText = '';
      batchCalculationResults.forEach(result => {
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}：` : '';
        copyText += `${switchPrefix}一段 ${calc.firstProtection.toFixed(2)}A 0.05秒  二段 ${calc.secondProtection.toFixed(2)}A 0.3秒  零序 ${calc.zeroSequence.toFixed(2)}A 0.4秒\n`;
      });
      
      navigator.clipboard.writeText(copyText).then(() => {
        // 创建成功提示
        const successMsg = document.createElement('div');
        successMsg.className = 'success-message';
        successMsg.innerHTML = '<span>✓</span><span>已复制到剪贴板</span>';
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      }).catch(() => {
        alert('复制失败，请手动复制');
      });
    }

    // 打印批量结果
    function printBatchResults() {
      window.print();
    }

    // 清空批量数据
    function clearBatchData() {
      document.getElementById('batchInput').value = '';
      document.getElementById('batchPreview').style.display = 'none';
      document.getElementById('batchResults').style.display = 'none';
      document.getElementById('batchCalculateBtn').disabled = true;
      document.getElementById('exportBatchBtn').disabled = true;
      batchData = [];
      batchCalculationResults = [];
    }

    // 显示容量选择器
    function showCapacitySelector() {
      document.getElementById('capacityModal').style.display = 'block';
      updateCapacityOptions();
    }

    // 关闭容量选择器
    function closeCapacityModal() {
      document.getElementById('capacityModal').style.display = 'none';
    }

    // 更新容量选项
    function updateCapacityOptions() {
      const type = document.getElementById('capacityType').value;
      const container = document.getElementById('capacityOptions');
      container.innerHTML = '';

      if (type === 'transformer') {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        grid.style.gap = '12px';
        
        transformerCapacities.forEach(cap => {
          const btn = document.createElement('button');
          btn.className = 'btn-primary';
          btn.style.padding = '12px';
          btn.textContent = cap + ' kVA';
          btn.onclick = () => {
            selectedCapacities.push({ type: 'transformer', value: cap });
            updateCapacityDisplay();
            closeCapacityModal();
          };
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      } else if (type === 'motor') {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        grid.style.gap = '12px';
        
        motorCapacities.forEach(cap => {
          const btn = document.createElement('button');
          btn.className = 'btn-primary';
          btn.style.padding = '12px';
          btn.textContent = cap + ' kW';
          btn.onclick = () => {
            selectedCapacities.push({ type: 'motor', value: cap });
            updateCapacityDisplay();
            closeCapacityModal();
          };
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      } else {
        container.innerHTML = `
          <div class="input-group" style="flex-direction: row;">
            <label>输入容量值：</label>
            <input type="number" id="customCapacityValue" min="0" step="0.1" style="flex: 1;">
            <select id="customCapacityUnit" style="width: auto; min-width: 150px;">
              <option value="kVA">kVA (变压器)</option>
              <option value="kW">kW (电机)</option>
            </select>
          </div>
        `;
      }
    }

    // 添加自定义容量
    function addSelectedCapacity() {
      const type = document.getElementById('capacityType').value;
      if (type === 'custom') {
        const value = parseFloat(document.getElementById('customCapacityValue').value);
        const unit = document.getElementById('customCapacityUnit').value;
        if (value && value > 0) {
          selectedCapacities.push({ 
            type: unit === 'kVA' ? 'transformer' : 'motor', 
            value: value 
          });
          updateCapacityDisplay();
          closeCapacityModal();
        } else {
          alert('请输入有效的容量值');
        }
      }
    }

    // 更新容量显示
    function updateCapacityDisplay() {
      const count = selectedCapacities.length;
      document.getElementById('capacityCount').textContent = `已选择 ${count} 个容量`;
      
      const listContainer = document.getElementById('selectedList');
      const selectedContainer = document.getElementById('selectedCapacities');
      
      if (count > 0) {
        selectedContainer.style.display = 'block';
        listContainer.innerHTML = '';
        
        selectedCapacities.forEach((cap, index) => {
          const item = document.createElement('div');
          
          const text = document.createElement('span');
          text.textContent = `${cap.value} ${cap.type === 'transformer' ? 'kVA' : 'kW'}`;
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = '×';
          removeBtn.onclick = () => {
            selectedCapacities.splice(index, 1);
            updateCapacityDisplay();
          };
          
          item.appendChild(text);
          item.appendChild(removeBtn);
          listContainer.appendChild(item);
        });
      } else {
        selectedContainer.style.display = 'none';
      }
    }

    // 解析变比值
    function parseRatio(ratioStr) {
      const match = ratioStr.match(/(\d+)\s*\/\s*(\d+)/);
      if (match) {
        return parseFloat(match[1]) / parseFloat(match[2]);
      }
      return null;
    }

    // 计算功能
    function calculate() {
      try {
        const switchName = document.getElementById('switchName').value.trim();
        const k3Input = document.getElementById('k3').value.trim();
        const k0Input = document.getElementById('k0').value.trim();
        const ctOption = document.getElementById('ctOption').value;

        const k3 = parseRatio(k3Input);
        const k0 = parseRatio(k0Input);

        if (!k3 || !k0 || k3 <= 0 || k0 <= 0) {
          alert('请输入有效的变比值，格式：XX/5');
          return;
        }

        if (selectedCapacities.length === 0) {
          alert('请至少选择一个容量值');
          return;
        }

        const result = calculateSingle(switchName, k3Input, k0Input, selectedCapacities, ctOption);

        if (!result) {
          alert('计算失败，请检查输入值');
          return;
        }

        // 显示结果
        document.getElementById('loadCurrent').textContent = result.loadCurrent.toFixed(2) + ' A';
        document.getElementById('firstProtection').textContent = result.firstProtection.toFixed(2) + ' A';
        document.getElementById('secondProtection').textContent = result.secondProtection.toFixed(2) + ' A';
        document.getElementById('firstProtectionPrimary').textContent = result.firstProtectionPrimary.toFixed(2) + ' A';
        document.getElementById('secondProtectionPrimary').textContent = result.secondProtectionPrimary.toFixed(2) + ' A';
        document.getElementById('zeroSequence').textContent = result.zeroSequence.toFixed(2) + ' A';
        
        // 获取开关名称
        const switchPrefix = switchName ? `${switchName}：` : '';
        
        document.getElementById('textResult').innerHTML = `
          <strong>定值配置建议：</strong>${switchPrefix}一段 ${result.firstProtection.toFixed(2)}A 0.05秒  二段 ${result.secondProtection.toFixed(2)}A 0.3秒  零序 ${result.zeroSequence.toFixed(2)}A 0.4秒
        `;
        
        document.getElementById('results').style.display = 'block';

        // 警告信息处理
        const warningContainer = document.getElementById('warningContainer');
        warningContainer.innerHTML = '';
        
        if (result.warning) {
          warningContainer.innerHTML = `
            <div class="warning-message">
              <span>⚠️</span>
              <span>负荷电流已达最大值（${result.loadCurrent.toFixed(2)}A > 853.2A），计算结果可能不适用，建议考虑专线供电方案。</span>
            </div>
          `;
        }

        // 滚动到结果区域
        document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'center' });

      } catch (error) {
        alert('计算出错：' + error.message);
        console.error('计算错误：', error);
      }
    }

    // 重置容量
    function resetCapacities() {
      if (selectedCapacities.length > 0 && !confirm('确定要清空所有已选容量吗？')) {
        return;
      }
      
      selectedCapacities = [];
      updateCapacityDisplay();
      
      // 清空结果
      document.getElementById('results').style.display = 'none';
      const resultIds = ['loadCurrent', 'firstProtection', 'secondProtection', 
                        'firstProtectionPrimary', 'secondProtectionPrimary', 'zeroSequence'];
      resultIds.forEach(id => {
        document.getElementById(id).textContent = '-';
      });
      document.getElementById('textResult').innerHTML = '';
      document.getElementById('warningContainer').innerHTML = '';
    }

    // 文字处理功能
    function processText() {
      const text = document.getElementById('inputText').value.trim();
      
      if (!text) {
        alert('请输入要处理的文字');
        return;
      }
      
      try {
        // 更智能的文字解析
        let result1 = '', result2 = '', result3 = '', result4 = '';
        
        // 解析变电站名称
        const stationMatch = text.match(/10kV(.+?)F\d+/);
        if (stationMatch) {
          result1 = stationMatch[1].trim();
        }
        
        // 解析馈线
        const feederMatch = text.match(/(10kV.+?F\d+)/);
        if (feederMatch) {
          result2 = feederMatch[1].replace('10kV', '').trim();
        }
        
        // 解析开关房
        const switchRoomMatch = text.match(/(.+?)G\d+/);
        if (switchRoomMatch) {
          result3 = switchRoomMatch[1].trim();
        }
        
        // 解析开关名称
        const switchNameMatch = text.match(/F\d+(.+?)$/);
        if (switchNameMatch) {
          result4 = switchNameMatch[1].trim();
        }

        // 显示结果
        document.getElementById('result1').textContent = result1 || '未识别';
        document.getElementById('result2').textContent = result2 || '未识别';
        document.getElementById('result3').textContent = result3 || '未识别';
        document.getElementById('result4').textContent = result4 || '未识别';
        document.getElementById('textResults').style.display = 'grid';
        
      } catch (error) {
        alert('处理文字时出错：' + error.message);
        console.error('文字处理错误：', error);
      }
    }

    // 清空文字处理结果
    function clearTextResults() {
      document.getElementById('inputText').value = '';
      document.getElementById('result1').textContent = '-';
      document.getElementById('result2').textContent = '-';
      document.getElementById('result3').textContent = '-';
      document.getElementById('result4').textContent = '-';
      document.getElementById('textResults').style.display = 'none';
    }

    // 导出结果功能
    function exportResults() {
      if (document.getElementById('results').style.display === 'none') {
        alert('请先进行计算');
        return;
      }
      
      const switchName = document.getElementById('switchName').value.trim();
      const k3Input = document.getElementById('k3').value.trim();
      const k0Input = document.getElementById('k0').value.trim();
      const ctOption = document.getElementById('ctOption').value === 'yes' ? '600A (变电站)' : '标准';
      
      const capacityList = selectedCapacities.map(cap => 
        `${cap.value} ${cap.type === 'transformer' ? 'kVA' : 'kW'}`
      ).join(', ');
      
      const results = `变压器继保定值计算结果
=====================================
计算时间：${new Date().toLocaleString()}

【输入参数】
开关名称：${switchName || '未填写'}
相序变比：${k3Input}
零序变比：${k0Input}
站出线CT规格：${ctOption}
已选容量：${capacityList}

【计算结果】
负荷电流：${document.getElementById('loadCurrent').textContent}
一段定值（二次值）：${document.getElementById('firstProtection').textContent}
二段定值（二次值）：${document.getElementById('secondProtection').textContent}
一段定值（一次值）：${document.getElementById('firstProtectionPrimary').textContent}
二段定值（一次值）：${document.getElementById('secondProtectionPrimary').textContent}
零序定值：${document.getElementById('zeroSequence').textContent}

【定值配置建议】
${document.getElementById('textResult').innerText}

${document.getElementById('warningContainer').innerText || ''}
=====================================
变压器继保定值计算器 v7.0
开发者：韩翰`;

      // 创建并下载文件
      const blob = new Blob([results], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `变压器定值计算_${new Date().getTime()}.txt`;
      link.click();
    }

    // 键盘快捷键支持
    document.addEventListener('keydown', function(e) {
      // Ctrl + Enter 计算
      if (e.ctrlKey && e.key === 'Enter') {
        calculate();
      }
      // Ctrl + R 重置
      else if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        resetCapacities();
      }
      // Ctrl + S 导出
      else if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        exportResults();
      }
    });

    // 点击模态框外部关闭
    document.getElementById('capacityModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCapacityModal();
      }
    });

    // 输入验证
    document.getElementById('k3').addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !value.match(/^\d+\s*\/\s*\d+$/)) {
        this.style.borderColor = 'var(--danger-color)';
      } else {
        this.style.borderColor = '';
      }
    });

    document.getElementById('k0').addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !value.match(/^\d+\s*\/\s*\d+$/)) {
        this.style.borderColor = 'var(--danger-color)';
      } else {
        this.style.borderColor = '';
      }
    });
  </script>
</body>
</html>
