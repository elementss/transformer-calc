<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>变压器继保定值计算器 v6.1</title>
  <style>
    /* CSS 变量定义 - 现代化配色方案 */
    :root {
      --primary-color: #5B5FDE;
      --primary-hover: #4A4ECC;
      --primary-light: #E8E9FF;
      --secondary-color: #6C757D;
      --success-color: #10B981;
      --success-light: #D1FAE5;
      --danger-color: #EF4444;
      --danger-light: #FEE2E2;
      --warning-color: #F59E0B;
      --warning-light: #FEF3C7;
      --info-color: #3B82F6;
      --info-light: #DBEAFE;
      
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: #FFFFFF;
      --bg-color: #F8F9FB;
      --border-color: #E5E7EB;
      --text-color: #1F2937;
      --text-secondary: #6B7280;
      --text-light: #9CA3AF;
      
      --radius-sm: 6px;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 暗色主题 */
    @media (prefers-color-scheme: dark) {
      :root {
        --card-bg: #1F2937;
        --bg-color: #111827;
        --border-color: #374151;
        --text-color: #F9FAFB;
        --text-secondary: #D1D5DB;
        --text-light: #9CA3AF;
        --primary-light: #312E81;
        --success-light: #064E3B;
        --danger-light: #7F1D1D;
        --warning-light: #78350F;
        --info-light: #1E3A8A;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* 背景装饰 */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 300px;
      background: var(--bg-gradient);
      z-index: -1;
      opacity: 0.1;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 头部设计 */
    .header {
      text-align: center;
      padding: 40px 20px;
      margin-bottom: 40px;
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: var(--bg-gradient);
      border-radius: 2px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version-info {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-top: 10px;
    }

    .version-info p {
      margin: 5px 0;
    }

    /* 标签页设计 */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 8px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .tab {
      flex: 1;
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--primary-color);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      opacity: 0.1;
    }

    .tab:hover {
      color: var(--primary-color);
      background: var(--primary-light);
    }

    .tab:hover::before {
      width: 100%;
      height: 100%;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 卡片设计 */
    .section {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .section:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-color);
    }

    .section-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-light);
      border-radius: var(--radius);
      font-size: 1.25rem;
    }

    /* 输入组设计 */
    .input-group {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    label {
      min-width: 150px;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input, select {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.875rem;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(91, 95, 222, 0.1);
    }

    input[readonly] {
      background-color: var(--bg-color);
      cursor: not-allowed;
      opacity: 0.7;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-family: 'Consolas', 'Monaco', monospace;
      resize: vertical;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(91, 95, 222, 0.1);
    }

    /* 按钮设计 */
    .button-group {
      display: flex;
      gap: 12px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #DC2626;
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #4B5563;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background: #D97706;
    }

    /* 容量选择器设计 */
    .capacity-container {
      margin: 25px 0;
      padding: 20px;
      background: var(--bg-color);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }

    .capacity-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .capacity-count {
      padding: 8px 16px;
      background: var(--primary-light);
      color: var(--primary-color);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    #selectedList {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #selectedList > div {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--info-light);
      color: var(--info-color);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #selectedList button {
      margin-left: 8px;
      background: none;
      border: none;
      color: var(--info-color);
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }

    #selectedList button:hover {
      background: var(--info-color);
      color: white;
      transform: scale(1.1);
    }

    /* 结果显示设计 */
    .results {
      margin-top: 30px;
      padding: 30px;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--card-bg) 100%);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .result-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .result-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .result-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .primary-value {
      color: var(--danger-color);
    }

    .text-result {
      padding: 20px;
      background: var(--info-light);
      border-left: 4px solid var(--info-color);
      border-radius: var(--radius);
      font-size: 1rem;
      line-height: 1.8;
      margin-top: 20px;
    }

    /* 消息提示设计 */
    .warning-message, .error-message, .success-message {
      margin-top: 20px;
      padding: 16px 20px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .warning-message {
      background: var(--warning-light);
      color: var(--warning-color);
      border: 1px solid var(--warning-color);
    }

    .error-message {
      background: var(--danger-light);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }

    .success-message {
      background: var(--success-light);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }

    /* 批量预览设计 */
    .batch-preview {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      padding: 15px;
      background: var(--bg-color);
    }

    .batch-item {
      padding: 15px;
      margin-bottom: 12px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .batch-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    .batch-item.error {
      border-color: var(--danger-color);
      background: var(--danger-light);
    }

    .batch-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .batch-item-details {
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    /* 统计信息设计 */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .stat-item {
      text-align: center;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .stat-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* 工具提示 */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background: var(--text-color);
      color: var(--card-bg);
      text-align: center;
      border-radius: var(--radius);
      padding: 8px 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
      box-shadow: var(--shadow-lg);
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--text-color) transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* 文字处理结果 */
    .text-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .text-result-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .text-result-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow);
    }

    .text-result-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .text-result-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    /* 模态框设计 */
    #capacityModal {
      backdrop-filter: blur(5px);
    }

    #capacityModal > div {
      background: var(--card-bg);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translate(-50%, -45%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    #capacityOptions > div {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    #capacityOptions button {
      padding: 12px;
      font-size: 0.875rem;
    }

    /* 批量结果设计 */
    .batch-result-item {
      margin-bottom: 25px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .batch-result-item:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .batch-result-header {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .batch-result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }

    .batch-result-grid > div {
      word-wrap: break-word;
      overflow-wrap: break-word;
      min-width: 0;
    }

    /* 加载动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        width: 100%;
      }
      
      .input-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      label {
        width: 100%;
      }
      
      input, select {
        width: 100%;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
      
      .result-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 打印样式 */
    @media print {
      body {
        background: white;
      }
      
      body::before {
        display: none;
      }
      
      .button-group, .tabs {
        display: none;
      }
      
      .section {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>变压器继保定值计算器</h1>
      <div class="version-info">
        <p>版本 6.1 | 250901 | 核心重构，全新UI设计</p>
        <p>开发者：hanhan | 反馈邮箱：icevivi8@gmail.com</p>
      </div>
    </div>

    <!-- 标签页导航 -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('single', this)">
        <span>⚡ 单个计算</span>
      </button>
      <button class="tab" onclick="switchTab('batch', this)">
        <span>📊 批量计算</span>
      </button>
      <button class="tab" onclick="switchTab('text', this)">
        <span>📝 文字处理</span>
      </button>
    </div>

    <!-- 单个计算标签页 -->
    <div id="single-tab" class="tab-content active">
      <div class="section">
        <h2>
          <span class="section-icon">⚡</span>
          变压器定值计算
        </h2>
        
        <!-- 基本参数设置 -->
        <div class="parameters-group">
          <div class="input-group">
            <label>🏷️ 开关名称</label>
            <input type="text" id="switchName" placeholder="请输入开关名称">
          </div>
          <div class="input-group">
            <label>🔄 相序变比</label>
            <input type="text" id="k3" value="600/5" placeholder="例如：600/5">
            <span class="tooltip">❓
              <span class="tooltiptext">相序CT变比，格式：XX/5</span>
            </span>
          </div>
          <div class="input-group">
            <label>⭕ 零序变比</label>
            <input type="text" id="k0" value="100/5" placeholder="例如：100/5">
            <span class="tooltip">❓
              <span class="tooltiptext">零序CT变比，格式：XX/5</span>
            </span>
          </div>
          <div class="input-group">
            <label>📊 站出线CT规格</label>
            <select id="ctOption">
              <option value="no" selected>标准</option>
              <option value="yes">600A (变电站)</option>
            </select>
          </div>
        </div>
        
        <!-- 容量选择区域 -->
        <div class="capacity-container">
          <div class="capacity-controls">
            <button class="btn-secondary" onclick="showCapacitySelector()">
              ➕ 添加容量
            </button>
            <span class="capacity-count" id="capacityCount">已选择 0 个容量</span>
          </div>
          <div id="selectedCapacities" style="display: none;">
            <h3 style="font-size: 1rem; margin-bottom: 15px; color: var(--text-secondary);">已选容量列表：</h3>
            <div id="selectedList"></div>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="button-group">
          <button class="btn-primary" onclick="calculate()">
            📊 计算变压器定值
          </button>
          <button class="btn-danger" onclick="resetCapacities()">
            🗑️ 清空已选容量
          </button>
          <button class="btn-secondary" onclick="exportResults()">
            📥 导出结果
          </button>
        </div>

        <!-- 计算结果显示 -->
        <div class="results" id="results" style="display: none">
          <h3 style="margin-top: 0; color: var(--primary-color);">计算结果</h3>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">负荷电流</div>
              <div class="result-value" id="loadCurrent">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">一段定值（二次值）</div>
              <div class="result-value" id="firstProtection">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">二段定值（二次值）</div>
              <div class="result-value" id="secondProtection">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">一段定值（一次值）</div>
              <div class="result-value primary-value" id="firstProtectionPrimary">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">二段定值（一次值）</div>
              <div class="result-value primary-value" id="secondProtectionPrimary">-</div>
            </div>
            <div class="result-item">
              <div class="result-label">零序定值</div>
              <div class="result-value" id="zeroSequence">-</div>
            </div>
          </div>
          <div class="text-result" id="textResult"></div>
          <div id="warningContainer"></div>
        </div>
      </div>
    </div>

    <!-- 批量计算标签页 -->
    <div id="batch-tab" class="tab-content">
      <div class="section">
        <h2>
          <span class="section-icon">📋</span>
          批量计算
        </h2>
        
        <div class="input-group">
          <label style="width: 100%; margin-bottom: 10px;">📝 粘贴批量数据（支持自动识别格式）</label>
        </div>
        <textarea id="batchInput" placeholder="请粘贴批量数据，系统将自动识别以下信息：
- 开关名称
- 变压器容量（支持kVA格式，支持多台相加如：1250kVA+1250kVA，支持乘法表达式如：1600kVA*3+1000kVA+800kVA，也支持部分省略单位如：2*1600+2*800kVA+2*1000kVA）
- 相序CT变比
- 零序CT变比

系统支持多种数据格式：
1. 带序号的格式（1、2、3...）
2. 逗号分隔的格式
3. 项目名称开头的格式
4. 自由文本格式

示例：
项目名称：xxx项目
开关名称：某某花城2号开关房G01柜601开关
开关后段变压器容量：630kVA
相序CT变比：600/5 10P20级
零序CT变比：100/5 10P10级"></textarea>

        <div class="button-group">
          <button class="btn-primary" onclick="parseBatchData()">
            🔍 解析数据
          </button>
          <button class="btn-success" onclick="calculateBatch()" id="batchCalculateBtn" disabled>
            📊 批量计算
          </button>
          <button class="btn-danger" onclick="clearBatchData()">
            🗑️ 清空数据
          </button>
          <button class="btn-secondary" onclick="exportBatchResults()" id="exportBatchBtn" disabled>
            📥 导出全部结果
          </button>
          <button class="btn-warning" onclick="loadSampleData()">
            📝 加载示例数据
          </button>
        </div>

        <!-- 解析预览 -->
        <div id="batchPreview" style="display: none;">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">解析结果预览</h3>
          
          <!-- 调试信息 -->
          <div id="debugInfo" style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 6px; font-family: monospace; font-size: 12px; display: none;">
            <div style="font-weight: bold; margin-bottom: 5px;">🔍 调试信息（浏览器兼容性诊断）</div>
            <div id="debugDetails"></div>
          </div>
          
          <div class="stats-container" id="batchStats"></div>
          <div class="batch-preview" id="batchPreviewContent"></div>
          
          <!-- 调试按钮 -->
          <div style="margin-top: 10px; text-align: center;">
            <button onclick="toggleDebugInfo()" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">
              🔧 显示/隐藏调试信息
            </button>
          </div>
        </div>

        <!-- 批量计算结果 -->
        <div id="batchResults" class="batch-results" style="display: none;">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">批量计算结果</h3>
          <div class="button-group">
            <button class="btn-secondary" onclick="copyAllResults()">
              📋 复制所有结果
            </button>
            <button class="btn-primary" onclick="printBatchResults()">
              🖨️ 打印结果
            </button>
          </div>
          <div id="batchResultsContent"></div>
        </div>
      </div>
    </div>

    <!-- 文字处理标签页 -->
    <div id="text-tab" class="tab-content">
      <div class="section">
        <h2>
          <span class="section-icon">📝</span>
          文字提取处理
        </h2>
        <div class="input-group">
          <label>📝 输入文字</label>
          <input type="text" id="inputText" style="flex: 1;"
                 placeholder="例如：10kV某热F29某某石东联社（某某路）开关房G03柜603开关">
        </div>
        <div class="button-group">
          <button class="btn-success" onclick="processText()">
            🔍 处理文字
          </button>
          <button class="btn-secondary" onclick="clearTextResults()">
            🗑️ 清空结果
          </button>
        </div>
        <div class="text-results" id="textResults" style="display: none;">
          <div class="text-result-item">
            <div class="text-result-label">变电站名称</div>
            <div class="text-result-value" id="result1">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">馈线</div>
            <div class="text-result-value" id="result2">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">开关房</div>
            <div class="text-result-value" id="result3">-</div>
          </div>
          <div class="text-result-item">
            <div class="text-result-label">开关名称</div>
            <div class="text-result-value" id="result4">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 容量选择模态框 -->
  <div id="capacityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      <h3 style="margin-bottom: 25px; color: var(--primary-color); font-size: 1.5rem;">选择容量</h3>
      <div style="margin: 25px 0;">
        <label style="margin-right: 15px; font-weight: 600;">容量类型：</label>
        <select id="capacityType" onchange="updateCapacityOptions()" style="padding: 10px 20px; border-radius: var(--radius); border: 2px solid var(--border-color);">
          <option value="transformer">变压器容量 (kVA)</option>
          <option value="motor">电机容量 (kW)</option>
          <option value="custom">自定义容量</option>
        </select>
      </div>
      <div id="capacityOptions" style="margin: 25px 0;"></div>
      <div class="button-group" style="justify-content: center; margin-top: 30px;">
        <button class="btn-primary" onclick="addSelectedCapacity()">确定</button>
        <button class="btn-secondary" onclick="closeCapacityModal()">取消</button>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let selectedCapacities = [];
    let batchData = [];
    let batchCalculationResults = [];
    const transformerCapacities = [30.5, 80, 100, 200, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3000];
    const motorCapacities = [5.5, 7.5, 11, 15, 18.5, 22, 30, 37, 45, 55, 75, 90, 110, 132, 160, 200, 250, 315];

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 浏览器兼容性检测
      checkBrowserCompatibility();
      
      // 初始化页面
      updateCapacityDisplay();
      
      // 初始化事件监听器
      initializeEventListeners();
    });

    // 浏览器兼容性检测
    function checkBrowserCompatibility() {
      var isCompatible = true;
      var warnings = [];
      
      // 检测基本的JavaScript功能
      try {
        // 检测正则表达式支持
        var testRegex = /test/;
        if (!testRegex.test) {
          isCompatible = false;
          warnings.push('正则表达式支持不完整');
        }
        
        // 检测数组方法支持
        var testArray = [1, 2, 3];
        if (!testArray.indexOf || !testArray.filter) {
          isCompatible = false;
          warnings.push('数组方法支持不完整');
        }
        
        // 检测字符串方法支持
        var testString = "test";
        if (!testString.trim || !testString.indexOf) {
          isCompatible = false;
          warnings.push('字符串方法支持不完整');
        }
        
        // 检测console支持
        if (typeof console === 'undefined' || !console.warn) {
          // 创建简单的console对象
          window.console = {
            log: function() {},
            warn: function() {},
            error: function() {}
          };
        }
        
      } catch (error) {
        isCompatible = false;
        warnings.push('JavaScript引擎兼容性问题');
      }
      
      // 如果有兼容性问题，显示警告
      if (!isCompatible || warnings.length > 0) {
        var warningMessage = '检测到浏览器兼容性问题：' + warnings.join('、') + 
          '\n建议使用Chrome、Firefox、Edge等现代浏览器以获得最佳体验。';
        
        // 延迟显示警告，避免阻塞页面加载
        setTimeout(function() {
          if (confirm(warningMessage + '\n\n是否继续使用？')) {
            console.log('用户选择继续使用');
          }
        }, 1000);
      }
    }

    // 初始化事件监听器
    function initializeEventListeners() {
      // 输入验证事件
      var k3Input = document.getElementById('k3');
      var k0Input = document.getElementById('k0');
      
      if (k3Input) {
        // 使用兼容的事件监听方式
        if (k3Input.addEventListener) {
          k3Input.addEventListener('input', validateK3Input);
        } else if (k3Input.attachEvent) {
          k3Input.attachEvent('oninput', validateK3Input);
        }
      }
      
      if (k0Input) {
        if (k0Input.addEventListener) {
          k0Input.addEventListener('input', validateK0Input);
        } else if (k0Input.attachEvent) {
          k0Input.attachEvent('oninput', validateK0Input);
        }
      }
    }

    // K3输入验证
    function validateK3Input() {
      var value = this.value ? this.value.trim() : '';
      var isValid = !value || /^\d+\s*\/\s*\d+$/.test(value);
      this.style.borderColor = isValid ? '' : 'var(--danger-color)';
    }

    // K0输入验证
    function validateK0Input() {
      var value = this.value ? this.value.trim() : '';
      var isValid = !value || /^\d+\s*\/\s*\d+$/.test(value);
      this.style.borderColor = isValid ? '' : 'var(--danger-color)';
    }

    // 标签页切换
    function switchTab(tabName, element) {
      // 移除所有活动状态
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // 激活选中的标签页
      element.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // 加载示例数据
    function loadSampleData() {
      const sampleData = `项目名称：某某市某某区珠某街吉山某某股份合作经济社业扩配套项目
电房名称：某某花城2号开关房
开关名称：某某城2号开关房G01柜601开关
开关后段变压器容量：630kVA
断路器柜厂家名称：穂达
微机厂家名称：珠海科众
相序CT变比：600/5 10P20级
零序CT变比：100/5 10P10级
送电时间：2025年07月16日
申请原因：新投运

，1、项目名称：某某区高某路某某号地块10kV供电设施迁改项目（临迁）
电房名称：10kV某塘F10高某路68号开关房
开关名称：10kV某塘F10高某路68号开关房G04柜
开关后段变压器容量：1250kVA+1250kVA
断路器柜厂家名称：希格玛电气（珠海）有限公司
微机厂家名称：珠海万力达电气技术股份有限公司
相序CT变比：600/5 10P10
零序CT变比：100/5 10P10
送电时间：2025.06.26
申请原因：新投产`;
      
      document.getElementById('batchInput').value = sampleData;
    }

    // 解析容量表达式 - 兼容性增强版本
    function parseCapacityExpressionSafe(capacityStr) {
      if (!capacityStr || typeof capacityStr !== 'string') {
        return [];
      }
      
      var capacities = [];
      
      try {
        // 标准化输入 - 使用更安全的替换方法
        var normalized = capacityStr.toLowerCase();
        normalized = normalized.replace(/[＋]/g, '+');
        normalized = normalized.replace(/[×]/g, '*');
        normalized = normalized.replace(/[，,]/g, '+');
        normalized = normalized.replace(/\s+/g, ' ');
        normalized = normalized.trim();
        
        // 按 + 分割
        var terms = normalized.split('+');
        
        for (var i = 0; i < terms.length; i++) {
          var term = terms[i].trim();
          if (!term) continue;
          
          // 处理乘法表达式（如：2*500kva）
          if (term.indexOf('*') !== -1) {
            // 使用更简单的正则表达式避免兼容性问题
            var multiplyParts = term.split('*');
            if (multiplyParts.length === 2) {
              var part1 = multiplyParts[0].trim();
              var part2 = multiplyParts[1].trim();
              
              // 提取数字
              var num1Match = part1.match(/(\d+(?:\.\d+)?)/);
              var num2Match = part2.match(/(\d+(?:\.\d+)?)/);
              
              if (num1Match && num2Match) {
                var num1 = parseFloat(num1Match[1]);
                var num2 = parseFloat(num2Match[1]);
                
                if (!isNaN(num1) && !isNaN(num2) && num1 > 0 && num2 > 0) {
                  var capacity, count;
                  
                  // 智能判断哪个是容量，哪个是数量
                  if (part2.indexOf('kva') !== -1) {
                    // 第二部分有kva，如 "3*1600kva"
                    capacity = num2;
                    count = num1;
                  } else if (part1.indexOf('kva') !== -1) {
                    // 第一部分有kva，如 "1600kva*3"
                    capacity = num1;
                    count = num2;
                  } else {
                    // 没有kva单位，智能判断
                    if (num1 >= 100 && num1 <= 5000 && num2 >= 1 && num2 <= 20) {
                      capacity = num1;
                      count = num2;
                    } else if (num2 >= 100 && num2 <= 5000 && num1 >= 1 && num1 <= 20) {
                      capacity = num2;
                      count = num1;
                    } else {
                      capacity = num1 > num2 ? num1 : num2;
                      count = num1 > num2 ? num2 : num1;
                    }
                  }
                  
                  // 添加多个相同容量的变压器
                  for (var j = 0; j < count; j++) {
                    capacities.push(capacity);
                  }
                }
              }
            }
          } else {
            // 处理单个容量值
            var singleMatch = term.match(/(\d+(?:\.\d+)?)/);
            if (singleMatch) {
              var capacity = parseFloat(singleMatch[1]);
              if (!isNaN(capacity) && capacity > 0) {
                capacities.push(capacity);
              }
            }
          }
        }
        
        return capacities.length > 0 ? capacities : [];
        
      } catch (error) {
        console.warn('容量解析出错:', error);
        return [];
      }
    }

    // 解析容量表达式，支持加法和乘法
    function parseCapacityExpression(capacityStr) {
      const capacities = [];
      
      // 移除空格并转换为标准格式
      let normalized = capacityStr.replace(/\s+/g, '').toLowerCase();
      
      // 处理不同的运算符
      normalized = normalized.replace(/[＋]/g, '+');
      normalized = normalized.replace(/[×]/g, '*');
      
      // 分割成项 (按 + 分割)
      const terms = normalized.split('+');
      
      for (let term of terms) {
        term = term.trim();
        
        // 检查是否包含乘法
        if (term.includes('*')) {
          // 解析乘法表达式，支持多种格式：
          // "1600kva*3", "3*1600kva", "2*1600", "1600*3"
          const multiplyMatch = term.match(/(\d+(?:\.\d+)?)(?:kva)?\s*\*\s*(\d+(?:\.\d+)?)(?:kva)?/);
          if (multiplyMatch) {
            const num1 = parseFloat(multiplyMatch[1]);
            const num2 = parseFloat(multiplyMatch[2]);
            
            // 判断哪个是容量，哪个是数量
            let capacity, count;
            
            // 检查是否有 kva 单位
            const hasKvaInTerm = term.includes('kva');
            const kvaPosition = term.indexOf('kva');
            const starPosition = term.indexOf('*');
            
            if (hasKvaInTerm) {
              // 有 kva 单位，根据位置判断
              if (kvaPosition < starPosition) {
                // kva 在 * 前面，如 "1600kva*3"
                capacity = num1;
                count = num2;
              } else {
                // kva 在 * 后面，如 "3*1600kva"
                capacity = num2;
                count = num1;
              }
            } else {
              // 没有 kva 单位，采用智能判断：
              // 通常较大的数是容量，较小的数是数量
              // 但也考虑常见的容量值范围 (100-5000kVA)
              if (num1 >= 100 && num1 <= 5000 && num2 >= 1 && num2 <= 20) {
                // num1 像容量值，num2 像数量，如 "1600*3"
                capacity = num1;
                count = num2;
              } else if (num2 >= 100 && num2 <= 5000 && num1 >= 1 && num1 <= 20) {
                // num2 像容量值，num1 像数量，如 "3*1600"
                capacity = num2;
                count = num1;
              } else {
                // 无法明确判断时，默认较大的是容量
                if (num1 > num2) {
                  capacity = num1;
                  count = num2;
                } else {
                  capacity = num2;
                  count = num1;
                }
              }
            }
            
            // 添加相应数量的容量
            for (let i = 0; i < count; i++) {
              capacities.push(capacity);
            }
          }
        } else {
          // 单个容量值
          const singleMatch = term.match(/(\d+(?:\.\d+)?)(?:kva)?/);
          if (singleMatch) {
            capacities.push(parseFloat(singleMatch[1]));
          }
        }
      }
      
      return capacities;
    }

    // 解析批量数据 - 兼容性增强版本
    function parseBatchData() {
      const input = document.getElementById('batchInput').value.trim();
      if (!input) {
        alert('请输入批量数据');
        return;
      }

      batchData = [];
      
      // 智能分割数据项 - 支持多种分隔方式（兼容性优化）
      let items = [];
      
      // 首先移除可能的干扰文本（如 @提及）
      let cleanInput = input.replace(/@[\u4e00-\u9fa5\w\s]+/g, '');
      
      // 方法1：尝试按数字序号分割（如：1、2、等）- 避免使用正向预查
      if (cleanInput.indexOf('项目名称') !== -1 && /\d+[、.]\s*项目名称/.test(cleanInput)) {
        // 使用兼容性更好的分割方法
        var tempItems = cleanInput.split(/\d+[、.]\s*项目名称/);
        items = [];
        var matches = cleanInput.match(/\d+[、.]\s*项目名称[^]*?(?=\d+[、.]\s*项目名称|$)/g);
        if (matches) {
          items = matches;
        } else {
          // 备用方法：手动分割
          var parts = cleanInput.split(/(\d+[、.]\s*)/);
          for (var i = 1; i < parts.length; i += 2) {
            if (i + 1 < parts.length && parts[i + 1].indexOf('项目名称') !== -1) {
              items.push(parts[i] + parts[i + 1]);
            }
          }
        }
      }
      // 方法2：尝试按"项目名称"分割（兼容性优化）
      else if (cleanInput.indexOf('项目名称') !== -1) {
        // 使用简单的分割，然后手动过滤
        var tempSplit = cleanInput.split('项目名称');
        items = [];
        for (var i = 1; i < tempSplit.length; i++) {
          var item = '项目名称' + tempSplit[i];
          // 确保包含必要的字段
          if (item.indexOf('开关名称') !== -1 && item.indexOf('变压器容量') !== -1) {
            items.push(item);
          }
        }
      }
      // 方法3：尝试按逗号分割（兼容性优化）
      else if (cleanInput.indexOf('，') !== -1 && cleanInput.indexOf('开关名称') !== -1) {
        items = cleanInput.split(/[，,]/);
        // 重新组合可能被错误分割的项目
        var mergedItems = [];
        var currentItem = '';
        for (var i = 0; i < items.length; i++) {
          currentItem += items[i];
          if (currentItem.indexOf('开关名称') !== -1 && currentItem.indexOf('变压器容量') !== -1) {
            mergedItems.push(currentItem);
            currentItem = '';
          } else if (i < items.length - 1) {
            currentItem += '，';
          }
        }
        if (currentItem.trim()) {
          mergedItems.push(currentItem);
        }
        items = mergedItems;
      }
      // 方法4：尝试按双换行符分割
      else {
        items = cleanInput.split(/\n\s*\n/);
      }
      
      // 过滤太短的项 - 使用更兼容的方式
      var filteredItems = [];
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        if (item && typeof item === 'string' && item.trim() && item.length > 50) {
          filteredItems.push(item);
        }
      }
      items = filteredItems;
      
      // 遍历每个项目进行解析 - 使用兼容性更好的方式
      for (var itemIndex = 0; itemIndex < items.length; itemIndex++) {
        var item = items[itemIndex];
        var data = {
          index: itemIndex + 1,
          rawText: item,
          parsed: {}
        };

        // 智能解析各字段 - 兼容性优化
        
        // 1. 解析开关名称 - 支持多种格式（避免复杂正则）
        var switchName = '';
        // 尝试第一种格式
        var switchMatch1 = item.match(/开关名称[：:]\s*([^\n]+)/);
        if (switchMatch1) {
          switchName = switchMatch1[1];
          // 进一步清理，移除可能的后续内容
          var cleanMatch = switchName.match(/^(.+?)(?=开关后段|断路器|微机|相序|零序|送电|申请|$)/);
          if (cleanMatch) {
            switchName = cleanMatch[1];
          }
        }
        if (switchName) {
          data.parsed.switchName = switchName.trim();
        }
        
        // 2. 解析变压器容量 - 兼容性优化（避免复杂的正向预查）
        var capacityStr = '';
        var capacityMatch1 = item.match(/变压器容量[：:]\s*([^\n]+)/);
        if (capacityMatch1) {
          capacityStr = capacityMatch1[1];
          // 进一步清理
          var cleanCapacity = capacityStr.match(/^(.+?)(?=断路器|微机|相序|零序|送电|申请|$)/);
          if (cleanCapacity) {
            capacityStr = cleanCapacity[1];
          }
        } else {
          // 备用方法：直接查找容量模式
          var capacityMatch2 = item.match(/(\d+(?:\.\d+)?\s*[kK][vV][aA](?:\s*[+＋*×]\s*\d+(?:\.\d+)?\s*(?:[kK][vV][aA])?)*)/i);
          if (capacityMatch2) {
            capacityStr = capacityMatch2[1];
          }
        }
        
        if (capacityStr) {
          // 解析容量字符串，支持加法和乘法 - 使用更安全的方法
          var parsedCapacities = parseCapacityExpressionSafe(capacityStr);
          
          if (parsedCapacities && parsedCapacities.length > 0) {
            data.parsed.capacities = parsedCapacities;
            data.parsed.capacityUnit = 'kVA';
            data.parsed.isMultiple = parsedCapacities.length > 1;
            data.parsed.capacityNote = parsedCapacities.length + '台变压器：' + capacityStr;
            data.parsed.capacity = parsedCapacities[0]; // 用于显示第一台
          }
        }
        
        // 3. 解析相序CT变比 - 简化正则表达式
        var k3Value = '';
        var k3Patterns = [
          /相序CT变比[：:]\s*(\d+)\s*[\/]\s*(\d+)/,
          /相序CT[：:]\s*(\d+)\s*[\/]\s*(\d+)/,
          /相序变比[：:]\s*(\d+)\s*[\/]\s*(\d+)/
        ];
        
        for (var p = 0; p < k3Patterns.length; p++) {
          var k3Match = item.match(k3Patterns[p]);
          if (k3Match) {
            k3Value = k3Match[1] + '/' + k3Match[2];
            break;
          }
        }
        if (k3Value) {
          data.parsed.k3 = k3Value;
        }
        
        // 4. 解析零序CT变比 - 简化正则表达式
        var k0Value = '';
        var k0Patterns = [
          /零序CT变比[：:]\s*(\d+)\s*[\/]\s*(\d+)/,
          /零序CT[：:]\s*(\d+)\s*[\/]\s*(\d+)/,
          /零序变比[：:]\s*(\d+)\s*[\/]\s*(\d+)/
        ];
        
        for (var p = 0; p < k0Patterns.length; p++) {
          var k0Match = item.match(k0Patterns[p]);
          if (k0Match) {
            k0Value = k0Match[1] + '/' + k0Match[2];
            break;
          }
        }
        if (k0Value) {
          data.parsed.k0 = k0Value;
        }
        
        // 5. 提取其他有用信息 - 简化正则
        // 项目名称
        var projectMatch = item.match(/项目名称[：:]\s*([^\n]+)/);
        if (projectMatch) {
          var projectName = projectMatch[1];
          // 清理后续内容
          var cleanProject = projectName.match(/^(.+?)(?=电房|$)/);
          if (cleanProject) {
            projectName = cleanProject[1];
          }
          data.parsed.projectName = projectName.trim();
        }
        
        // 电房名称
        var roomMatch = item.match(/电房名称[：:]\s*([^\n]+)/);
        if (roomMatch) {
          var roomName = roomMatch[1];
          var cleanRoom = roomName.match(/^(.+?)(?=开关名称|$)/);
          if (cleanRoom) {
            roomName = cleanRoom[1];
          }
          data.parsed.roomName = roomName.trim();
        }
        
        // 送电时间
        var dateMatch = item.match(/送电时间[：:]\s*([^\n]+)/);
        if (dateMatch) {
          var powerDate = dateMatch[1];
          var cleanDate = powerDate.match(/^(.+?)(?=申请|$)/);
          if (cleanDate) {
            powerDate = cleanDate[1];
          }
          data.parsed.powerOnDate = powerDate.trim();
        }

        // 检查必要字段
        if (data.parsed.switchName && data.parsed.capacity && data.parsed.k3 && data.parsed.k0) {
          data.status = 'success';
        } else {
          data.status = 'error';
          var missingFields = [];
          if (!data.parsed.switchName) missingFields.push('开关名称');
          if (!data.parsed.capacity) missingFields.push('变压器容量');
          if (!data.parsed.k3) missingFields.push('相序CT变比');
          if (!data.parsed.k0) missingFields.push('零序CT变比');
          data.error = '缺少字段：' + missingFields.join('、');
        }

        batchData.push(data);
      }

      // 显示解析结果
      displayBatchPreview();
    }

    // 显示批量数据预览 - 增强版本
    function displayBatchPreview() {
      var previewContainer = document.getElementById('batchPreview');
      var previewContent = document.getElementById('batchPreviewContent');
      var statsContainer = document.getElementById('batchStats');
      
      // 更新调试信息
      updateDebugInfo();
      
      // 统计信息
      var successCount = 0;
      var errorCount = 0;
      for (var i = 0; i < batchData.length; i++) {
        if (batchData[i].status === 'success') {
          successCount++;
        } else {
          errorCount++;
        }
      }
      
      statsContainer.innerHTML = 
        '<div class="stat-item">' +
          '<div class="stat-value">' + batchData.length + '</div>' +
          '<div class="stat-label">总数据条数</div>' +
        '</div>' +
        '<div class="stat-item" style="background: var(--success-light);">' +
          '<div class="stat-value" style="color: var(--success-color);">' + successCount + '</div>' +
          '<div class="stat-label">解析成功</div>' +
        '</div>' +
        '<div class="stat-item" style="background: var(--danger-light);">' +
          '<div class="stat-value" style="color: var(--danger-color);">' + errorCount + '</div>' +
          '<div class="stat-label">解析失败</div>' +
        '</div>';
      
      // 预览内容
      previewContent.innerHTML = '';
      for (var i = 0; i < batchData.length; i++) {
        var data = batchData[i];
        var itemDiv = document.createElement('div');
        itemDiv.className = 'batch-item' + (data.status === 'error' ? ' error' : '');
        
        if (data.status === 'success') {
          var capacityDisplay = data.parsed.isMultiple && data.parsed.capacities 
            ? data.parsed.capacities.join('+') + ' ' + data.parsed.capacityUnit
            : data.parsed.capacity + ' ' + data.parsed.capacityUnit;
            
          itemDiv.innerHTML = 
            '<div class="batch-item-header">' +
              '<span>序号 ' + data.index + ': ' + data.parsed.switchName + '</span>' +
              '<span style="color: var(--success-color);">✓</span>' +
            '</div>' +
            '<div class="batch-item-details">' +
              '<div>容量: ' + capacityDisplay + (data.parsed.capacityNote ? ' (' + data.parsed.capacityNote + ')' : '') + '</div>' +
              '<div>相序变比: ' + data.parsed.k3 + '</div>' +
              '<div>零序变比: ' + data.parsed.k0 + '</div>' +
              (data.parsed.projectName ? '<div>项目: ' + data.parsed.projectName + '</div>' : '') +
              (data.parsed.powerOnDate ? '<div>送电时间: ' + data.parsed.powerOnDate + '</div>' : '') +
            '</div>';
        } else {
          itemDiv.innerHTML = 
            '<div class="batch-item-header">' +
              '<span>序号 ' + data.index + '</span>' +
              '<span style="color: var(--danger-color);">✗ ' + data.error + '</span>' +
            '</div>' +
            '<div class="batch-item-details" style="color: var(--danger-color);">' +
              data.rawText.substring(0, 100) + '...' +
            '</div>';
        }
        
        previewContent.appendChild(itemDiv);
      }
      
      previewContainer.style.display = 'block';
      
      // 启用/禁用批量计算按钮
      document.getElementById('batchCalculateBtn').disabled = successCount === 0;
    }

    // 更新调试信息
    function updateDebugInfo() {
      var debugDetails = document.getElementById('debugDetails');
      if (!debugDetails) return;
      
      var browserInfo = getBrowserInfo();
      var regexSupport = checkRegexSupport();
      
      var debugHtml = '';
      debugHtml += '<div>浏览器: ' + browserInfo.name + ' ' + browserInfo.version + '</div>';
      debugHtml += '<div>用户代理: ' + navigator.userAgent.substring(0, 100) + '...</div>';
      debugHtml += '<div>正则表达式支持: ' + (regexSupport.basic ? '✓' : '✗') + ' 基础, ' + 
                   (regexSupport.lookahead ? '✓' : '✗') + ' 正向预查</div>';
      debugHtml += '<div>数组方法支持: ' + (Array.prototype.filter ? '✓' : '✗') + ' filter, ' + 
                   (Array.prototype.indexOf ? '✓' : '✗') + ' indexOf</div>';
      debugHtml += '<div>字符串方法支持: ' + (String.prototype.trim ? '✓' : '✗') + ' trim, ' + 
                   (String.prototype.includes ? '✓' : '✗') + ' includes</div>';
      debugHtml += '<div>识别方法使用: ' + getUsedParsingMethod() + '</div>';
      
      debugDetails.innerHTML = debugHtml;
    }

    // 获取浏览器信息
    function getBrowserInfo() {
      var ua = navigator.userAgent;
      var browser = { name: 'Unknown', version: 'Unknown' };
      
      if (ua.indexOf('Chrome') !== -1) {
        browser.name = 'Chrome';
        var match = ua.match(/Chrome\/(\d+)/);
        if (match) browser.version = match[1];
      } else if (ua.indexOf('Firefox') !== -1) {
        browser.name = 'Firefox';
        var match = ua.match(/Firefox\/(\d+)/);
        if (match) browser.version = match[1];
      } else if (ua.indexOf('Safari') !== -1) {
        browser.name = 'Safari';
        var match = ua.match(/Version\/(\d+)/);
        if (match) browser.version = match[1];
      } else if (ua.indexOf('Edge') !== -1) {
        browser.name = 'Edge';
        var match = ua.match(/Edge\/(\d+)/);
        if (match) browser.version = match[1];
      } else if (ua.indexOf('MSIE') !== -1 || ua.indexOf('Trident') !== -1) {
        browser.name = 'Internet Explorer';
        var match = ua.match(/(?:MSIE |rv:)(\d+)/);
        if (match) browser.version = match[1];
      }
      
      return browser;
    }

    // 检查正则表达式支持
    function checkRegexSupport() {
      var support = { basic: true, lookahead: true };
      
      try {
        var testRegex = /test/;
        testRegex.test('test');
      } catch (e) {
        support.basic = false;
      }
      
      try {
        var lookaheadRegex = /test(?=ahead)/;
        lookaheadRegex.test('testahead');
      } catch (e) {
        support.lookahead = false;
      }
      
      return support;
    }

    // 获取使用的解析方法
    function getUsedParsingMethod() {
      var input = document.getElementById('batchInput').value.trim();
      if (!input) return '无数据';
      
      var cleanInput = input.replace(/@[\u4e00-\u9fa5\w\s]+/g, '');
      
      if (cleanInput.indexOf('项目名称') !== -1 && /\d+[、.]\s*项目名称/.test(cleanInput)) {
        return '数字序号分割';
      } else if (cleanInput.indexOf('项目名称') !== -1) {
        return '项目名称分割';
      } else if (cleanInput.indexOf('，') !== -1 && cleanInput.indexOf('开关名称') !== -1) {
        return '逗号分割';
      } else {
        return '双换行分割';
      }
    }

    // 切换调试信息显示
    function toggleDebugInfo() {
      var debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
      }
    }

    // 批量计算
    function calculateBatch() {
      batchCalculationResults = [];
      const successData = batchData.filter(d => d.status === 'success');
      
      successData.forEach(data => {
        let capacities;
        
        // 判断是否为多台变压器
        if (data.parsed.isMultiple && data.parsed.capacities) {
          // 多台变压器，每台都作为独立的容量
          capacities = data.parsed.capacities.map(cap => ({ type: 'transformer', value: cap }));
        } else {
          // 单台变压器
          capacities = [{ type: 'transformer', value: data.parsed.capacity }];
        }
        
        const result = calculateSingle(
          data.parsed.switchName,
          data.parsed.k3,
          data.parsed.k0,
          capacities,
          'no' // 默认使用标准CT
        );
        
        batchCalculationResults.push({
          ...data,
          calculation: result
        });
      });
      
      displayBatchResults();
    }

    // 单个计算核心函数
    function calculateSingle(switchName, k3Input, k0Input, capacities, ctOption) {
      const k3 = parseRatio(k3Input);
      const k0 = parseRatio(k0Input);

      if (!k3 || !k0 || k3 <= 0 || k0 <= 0) {
        return null;
      }

      const transformerCaps = capacities.filter(c => c.type === 'transformer').map(c => c.value);
      const motorCaps = capacities.filter(c => c.type === 'motor').map(c => c.value);

      // 计算变压器负荷电流
      const transformerLoadCurrent = transformerCaps.length > 0 ?
            transformerCaps.reduce((sum, cap) => sum + cap, 0) / (10.5 * 1.732) : 0;

      // 计算一段保护定值
      let firstProtection = 0;
      if (transformerCaps.length > 0) {
        const maxNormal = Math.max(...transformerCaps);
        const countNormal = transformerCaps.length;
        const coefficient = countNormal <= 3 ? 25 : (countNormal <= 6 ? 30 : 35);
        const firstProtectionCalc = (maxNormal * coefficient) / (10.5 * 1.732);
        firstProtection = Math.max(0.57, Math.min(firstProtectionCalc, 2479) / k3);
      } else if (motorCaps.length > 0) {
        const maxMotor = Math.max(...motorCaps);
        const countMotor = motorCaps.length;
        const coefficient = countMotor <= 3 ? 25 : (countMotor <= 6 ? 30 : 35);
        const firstProtectionCalc = (maxMotor * coefficient) / (10.5 * 1.732);
        firstProtection = Math.max(0.57, Math.min(firstProtectionCalc, 2479) / k3);
      }

      // 计算电机负荷电流
      let motorLoadCurrent = 0;
      if (motorCaps.length > 0) {
        if (motorCaps.length === 1) {
          motorLoadCurrent = motorCaps[0] * 9 / 100 * 8;
        } else {
          let sum = 0;
          for (let i = 0; i < motorCaps.length - 1; i++) {
            sum += motorCaps[i] * 9 / 100;
          }
          let lastMotor = motorCaps[motorCaps.length - 1] * 9 / 100 * 8;
          motorLoadCurrent = sum + lastMotor;
        }
      }

      // 计算二段保护用负荷电流
      let loadCurrentForSecond;
      if (transformerCaps.length > 0 && motorCaps.length > 0) {
        loadCurrentForSecond = (transformerLoadCurrent + motorLoadCurrent) * 1.3;
      } else if (motorCaps.length > 0) {
        loadCurrentForSecond = motorLoadCurrent * 1.3;
      } else {
        loadCurrentForSecond = transformerLoadCurrent;
      }

      // 计算二段保护定值
      let secondProtection;
      if (loadCurrentForSecond > 548) {
        secondProtection = 1040 * 0.82 / k3;
      } else {
        const baseValue = Math.max(1.56 * loadCurrentForSecond, 0.1) / k3;
        let minCapacity;
        if (transformerCaps.length > 0) {
          minCapacity = Math.min(...transformerCaps);
        } else if (motorCaps.length > 0) {
          minCapacity = Math.min(...motorCaps);
        }
        
        let capacityBased;
        if (minCapacity < 315) {
          capacityBased = 8 * minCapacity / (10.5 * 1.732 * k3);
        } else {
          const capacityMap = {
            315: 150, 400: 190, 500: 220, 630: 260, 800: 310
          };
          if (capacityMap[minCapacity]) {
            capacityBased = capacityMap[minCapacity] / k3;
          } else if (minCapacity > 2000) {
            capacityBased = 5 * minCapacity / (10.5 * 1.732 * k3);
          } else {
            capacityBased = 6 * minCapacity / (10.5 * 1.732 * k3);
          }
        }
        secondProtection = Math.max(0.18, Math.max(baseValue, capacityBased));
      }
      
      // CT选项处理
      if (ctOption === 'yes' && secondProtection > 5.33) {
        secondProtection = 5.33;
      }

      // 确保一段定值大于二段定值的1.1倍
      if (firstProtection < secondProtection * 1.1) {
        firstProtection = secondProtection * 1.1;
      }

      // 计算一次值
      const firstProtectionPrimary = firstProtection * k3;
      const secondProtectionPrimary = secondProtection * k3;

      // 计算零序定值
      const zeroSequence = 2.25 / k0 * 20;

      return {
        loadCurrent: loadCurrentForSecond,
        firstProtection: firstProtection,
        secondProtection: secondProtection,
        firstProtectionPrimary: firstProtectionPrimary,
        secondProtectionPrimary: secondProtectionPrimary,
        zeroSequence: zeroSequence,
        warning: loadCurrentForSecond > 853.2
      };
    }

    // 显示批量计算结果
    function displayBatchResults() {
      const resultsContainer = document.getElementById('batchResults');
      const resultsContent = document.getElementById('batchResultsContent');
      
      resultsContent.innerHTML = '';
      
      batchCalculationResults.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'batch-result-item';
        
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}：` : '';
        
        // 容量显示处理
        const capacityDisplay = result.parsed.isMultiple && result.parsed.capacities 
          ? `${result.parsed.capacities.join('+')} ${result.parsed.capacityUnit}` 
          : `${result.parsed.capacity} ${result.parsed.capacityUnit}`;
        
        resultDiv.innerHTML = `
          <div class="batch-result-header">
            <span>📊</span>
            序号 ${result.index}: ${result.parsed.switchName}
          </div>
          <div style="margin-bottom: 15px; padding: 12px; background: var(--primary-light); border-radius: var(--radius-sm); border-left: 4px solid var(--primary-color);">
            <div class="result-label" style="font-size: 0.9rem; margin-bottom: 5px;">变压器容量</div>
            <div style="font-weight: bold; font-size: 1.1rem; color: var(--primary-color); word-break: break-all;">${capacityDisplay}</div>
          </div>
          <div class="batch-result-grid">
            <div>
              <div class="result-label">负荷电流</div>
              <div style="font-weight: bold;">${calc.loadCurrent.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">一段定值（二次值）</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.firstProtection.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">二段定值（二次值）</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.secondProtection.toFixed(2)} A</div>
            </div>
            <div>
              <div class="result-label">零序定值</div>
              <div style="font-weight: bold; color: var(--primary-color);">${calc.zeroSequence.toFixed(2)} A</div>
            </div>
          </div>
          <div class="text-result">
            <strong>定值配置建议：</strong>${switchPrefix}一段 ${calc.firstProtection.toFixed(2)}A 0.05秒  二段 ${calc.secondProtection.toFixed(2)}A 0.3秒  零序 ${calc.zeroSequence.toFixed(2)}A 0.4秒
          </div>
          ${calc.warning ? '<div class="warning-message"><span>⚠️</span><span>负荷电流超过最大值，建议考虑专线供电方案。</span></div>' : ''}
        `;
        
        resultsContent.appendChild(resultDiv);
      });
      
      resultsContainer.style.display = 'block';
      document.getElementById('exportBatchBtn').disabled = false;
      
      // 滚动到结果区域
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 导出批量结果
    function exportBatchResults() {
      if (batchCalculationResults.length === 0) {
        alert('请先进行批量计算');
        return;
      }
      
      let exportText = `变压器继保定值批量计算结果
=====================================
计算时间：${new Date().toLocaleString()}
计算数量：${batchCalculationResults.length} 条

`;
      
      batchCalculationResults.forEach(result => {
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}：` : '';
        
        // 容量显示处理
        const capacityDisplay = result.parsed.isMultiple && result.parsed.capacities 
          ? `${result.parsed.capacities.join('+')} ${result.parsed.capacityUnit}` 
          : `${result.parsed.capacity} ${result.parsed.capacityUnit}`;
        
        exportText += `
【序号 ${result.index}】
开关名称：${result.parsed.switchName}
容量：${capacityDisplay}${result.parsed.capacityNote ? ` (${result.parsed.capacityNote})` : ''}
相序变比：${result.parsed.k3}
零序变比：${result.parsed.k0}

计算结果：
负荷电流：${calc.loadCurrent.toFixed(2)} A
一段定值（二次值）：${calc.firstProtection.toFixed(2)} A
二段定值（二次值）：${calc.secondProtection.toFixed(2)} A
一段定值（一次值）：${calc.firstProtectionPrimary.toFixed(2)} A
二段定值（一次值）：${calc.secondProtectionPrimary.toFixed(2)} A
零序定值：${calc.zeroSequence.toFixed(2)} A

定值配置建议：${switchPrefix}一段 ${calc.firstProtection.toFixed(2)}A 0.05秒  二段 ${calc.secondProtection.toFixed(2)}A 0.3秒  零序 ${calc.zeroSequence.toFixed(2)}A 0.4秒
${calc.warning ? '\n⚠️ 警告：负荷电流超过最大值，建议考虑专线供电方案。' : ''}
=====================================
`;
      });
      
      exportText += `
变压器继保定值计算器 v6.0
开发者：hanhan`;
      
      // 创建并下载文件
      const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `批量定值计算_${new Date().getTime()}.txt`;
      link.click();
    }

    // 复制所有结果
    function copyAllResults() {
      if (batchCalculationResults.length === 0) {
        alert('没有可复制的结果');
        return;
      }
      
      let copyText = '';
      batchCalculationResults.forEach(result => {
        const calc = result.calculation;
        const switchPrefix = result.parsed.switchName ? `${result.parsed.switchName}：` : '';
        copyText += `${switchPrefix}一段 ${calc.firstProtection.toFixed(2)}A 0.05秒  二段 ${calc.secondProtection.toFixed(2)}A 0.3秒  零序 ${calc.zeroSequence.toFixed(2)}A 0.4秒\n`;
      });
      
      navigator.clipboard.writeText(copyText).then(() => {
        // 创建成功提示
        const successMsg = document.createElement('div');
        successMsg.className = 'success-message';
        successMsg.innerHTML = '<span>✓</span><span>已复制到剪贴板</span>';
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      }).catch(() => {
        alert('复制失败，请手动复制');
      });
    }

    // 打印批量结果
    function printBatchResults() {
      window.print();
    }

    // 清空批量数据
    function clearBatchData() {
      document.getElementById('batchInput').value = '';
      document.getElementById('batchPreview').style.display = 'none';
      document.getElementById('batchResults').style.display = 'none';
      document.getElementById('batchCalculateBtn').disabled = true;
      document.getElementById('exportBatchBtn').disabled = true;
      batchData = [];
      batchCalculationResults = [];
    }

    // 显示容量选择器
    function showCapacitySelector() {
      document.getElementById('capacityModal').style.display = 'block';
      updateCapacityOptions();
    }

    // 关闭容量选择器
    function closeCapacityModal() {
      document.getElementById('capacityModal').style.display = 'none';
    }

    // 更新容量选项
    function updateCapacityOptions() {
      const type = document.getElementById('capacityType').value;
      const container = document.getElementById('capacityOptions');
      container.innerHTML = '';

      if (type === 'transformer') {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        grid.style.gap = '12px';
        
        transformerCapacities.forEach(cap => {
          const btn = document.createElement('button');
          btn.className = 'btn-primary';
          btn.style.padding = '12px';
          btn.textContent = cap + ' kVA';
          btn.onclick = () => {
            selectedCapacities.push({ type: 'transformer', value: cap });
            updateCapacityDisplay();
            closeCapacityModal();
          };
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      } else if (type === 'motor') {
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        grid.style.gap = '12px';
        
        motorCapacities.forEach(cap => {
          const btn = document.createElement('button');
          btn.className = 'btn-primary';
          btn.style.padding = '12px';
          btn.textContent = cap + ' kW';
          btn.onclick = () => {
            selectedCapacities.push({ type: 'motor', value: cap });
            updateCapacityDisplay();
            closeCapacityModal();
          };
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      } else {
        container.innerHTML = `
          <div class="input-group" style="flex-direction: row;">
            <label>输入容量值：</label>
            <input type="number" id="customCapacityValue" min="0" step="0.1" style="flex: 1;">
            <select id="customCapacityUnit" style="width: auto; min-width: 150px;">
              <option value="kVA">kVA (变压器)</option>
              <option value="kW">kW (电机)</option>
            </select>
          </div>
        `;
      }
    }

    // 添加自定义容量
    function addSelectedCapacity() {
      const type = document.getElementById('capacityType').value;
      if (type === 'custom') {
        const value = parseFloat(document.getElementById('customCapacityValue').value);
        const unit = document.getElementById('customCapacityUnit').value;
        if (value && value > 0) {
          selectedCapacities.push({ 
            type: unit === 'kVA' ? 'transformer' : 'motor', 
            value: value 
          });
          updateCapacityDisplay();
          closeCapacityModal();
        } else {
          alert('请输入有效的容量值');
        }
      }
    }

    // 更新容量显示
    function updateCapacityDisplay() {
      const count = selectedCapacities.length;
      document.getElementById('capacityCount').textContent = `已选择 ${count} 个容量`;
      
      const listContainer = document.getElementById('selectedList');
      const selectedContainer = document.getElementById('selectedCapacities');
      
      if (count > 0) {
        selectedContainer.style.display = 'block';
        listContainer.innerHTML = '';
        
        selectedCapacities.forEach((cap, index) => {
          const item = document.createElement('div');
          
          const text = document.createElement('span');
          text.textContent = `${cap.value} ${cap.type === 'transformer' ? 'kVA' : 'kW'}`;
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = '×';
          removeBtn.onclick = () => {
            selectedCapacities.splice(index, 1);
            updateCapacityDisplay();
          };
          
          item.appendChild(text);
          item.appendChild(removeBtn);
          listContainer.appendChild(item);
        });
      } else {
        selectedContainer.style.display = 'none';
      }
    }

    // 解析变比值
    function parseRatio(ratioStr) {
      const match = ratioStr.match(/(\d+)\s*\/\s*(\d+)/);
      if (match) {
        return parseFloat(match[1]) / parseFloat(match[2]);
      }
      return null;
    }

    // 计算功能
    function calculate() {
      try {
        const switchName = document.getElementById('switchName').value.trim();
        const k3Input = document.getElementById('k3').value.trim();
        const k0Input = document.getElementById('k0').value.trim();
        const ctOption = document.getElementById('ctOption').value;

        const k3 = parseRatio(k3Input);
        const k0 = parseRatio(k0Input);

        if (!k3 || !k0 || k3 <= 0 || k0 <= 0) {
          alert('请输入有效的变比值，格式：XX/5');
          return;
        }

        if (selectedCapacities.length === 0) {
          alert('请至少选择一个容量值');
          return;
        }

        const result = calculateSingle(switchName, k3Input, k0Input, selectedCapacities, ctOption);

        if (!result) {
          alert('计算失败，请检查输入值');
          return;
        }

        // 显示结果
        document.getElementById('loadCurrent').textContent = result.loadCurrent.toFixed(2) + ' A';
        document.getElementById('firstProtection').textContent = result.firstProtection.toFixed(2) + ' A';
        document.getElementById('secondProtection').textContent = result.secondProtection.toFixed(2) + ' A';
        document.getElementById('firstProtectionPrimary').textContent = result.firstProtectionPrimary.toFixed(2) + ' A';
        document.getElementById('secondProtectionPrimary').textContent = result.secondProtectionPrimary.toFixed(2) + ' A';
        document.getElementById('zeroSequence').textContent = result.zeroSequence.toFixed(2) + ' A';
        
        // 获取开关名称
        const switchPrefix = switchName ? `${switchName}：` : '';
        
        document.getElementById('textResult').innerHTML = `
          <strong>定值配置建议：</strong>${switchPrefix}一段 ${result.firstProtection.toFixed(2)}A 0.05秒  二段 ${result.secondProtection.toFixed(2)}A 0.3秒  零序 ${result.zeroSequence.toFixed(2)}A 0.4秒
        `;
        
        document.getElementById('results').style.display = 'block';

        // 警告信息处理
        const warningContainer = document.getElementById('warningContainer');
        warningContainer.innerHTML = '';
        
        if (result.warning) {
          warningContainer.innerHTML = `
            <div class="warning-message">
              <span>⚠️</span>
              <span>负荷电流已达最大值（${result.loadCurrent.toFixed(2)}A > 853.2A），计算结果可能不适用，建议考虑专线供电方案。</span>
            </div>
          `;
        }

        // 滚动到结果区域
        document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'center' });

      } catch (error) {
        alert('计算出错：' + error.message);
        console.error('计算错误：', error);
      }
    }

    // 重置容量
    function resetCapacities() {
      if (selectedCapacities.length > 0 && !confirm('确定要清空所有已选容量吗？')) {
        return;
      }
      
      selectedCapacities = [];
      updateCapacityDisplay();
      
      // 清空结果
      document.getElementById('results').style.display = 'none';
      const resultIds = ['loadCurrent', 'firstProtection', 'secondProtection', 
                        'firstProtectionPrimary', 'secondProtectionPrimary', 'zeroSequence'];
      resultIds.forEach(id => {
        document.getElementById(id).textContent = '-';
      });
      document.getElementById('textResult').innerHTML = '';
      document.getElementById('warningContainer').innerHTML = '';
    }

    // 文字处理功能
    function processText() {
      const text = document.getElementById('inputText').value.trim();
      
      if (!text) {
        alert('请输入要处理的文字');
        return;
      }
      
      try {
        // 更智能的文字解析
        let result1 = '', result2 = '', result3 = '', result4 = '';
        
        // 解析变电站名称
        const stationMatch = text.match(/10kV(.+?)F\d+/);
        if (stationMatch) {
          result1 = stationMatch[1].trim();
        }
        
        // 解析馈线
        const feederMatch = text.match(/(10kV.+?F\d+)/);
        if (feederMatch) {
          result2 = feederMatch[1].replace('10kV', '').trim();
        }
        
        // 解析开关房
        const switchRoomMatch = text.match(/(.+?)G\d+/);
        if (switchRoomMatch) {
          result3 = switchRoomMatch[1].trim();
        }
        
        // 解析开关名称
        const switchNameMatch = text.match(/F\d+(.+?)$/);
        if (switchNameMatch) {
          result4 = switchNameMatch[1].trim();
        }

        // 显示结果
        document.getElementById('result1').textContent = result1 || '未识别';
        document.getElementById('result2').textContent = result2 || '未识别';
        document.getElementById('result3').textContent = result3 || '未识别';
        document.getElementById('result4').textContent = result4 || '未识别';
        document.getElementById('textResults').style.display = 'grid';
        
      } catch (error) {
        alert('处理文字时出错：' + error.message);
        console.error('文字处理错误：', error);
      }
    }

    // 清空文字处理结果
    function clearTextResults() {
      document.getElementById('inputText').value = '';
      document.getElementById('result1').textContent = '-';
      document.getElementById('result2').textContent = '-';
      document.getElementById('result3').textContent = '-';
      document.getElementById('result4').textContent = '-';
      document.getElementById('textResults').style.display = 'none';
    }

    // 导出结果功能
    function exportResults() {
      if (document.getElementById('results').style.display === 'none') {
        alert('请先进行计算');
        return;
      }
      
      const switchName = document.getElementById('switchName').value.trim();
      const k3Input = document.getElementById('k3').value.trim();
      const k0Input = document.getElementById('k0').value.trim();
      const ctOption = document.getElementById('ctOption').value === 'yes' ? '600A (变电站)' : '标准';
      
      const capacityList = selectedCapacities.map(cap => 
        `${cap.value} ${cap.type === 'transformer' ? 'kVA' : 'kW'}`
      ).join(', ');
      
      const results = `变压器继保定值计算结果
=====================================
计算时间：${new Date().toLocaleString()}

【输入参数】
开关名称：${switchName || '未填写'}
相序变比：${k3Input}
零序变比：${k0Input}
站出线CT规格：${ctOption}
已选容量：${capacityList}

【计算结果】
负荷电流：${document.getElementById('loadCurrent').textContent}
一段定值（二次值）：${document.getElementById('firstProtection').textContent}
二段定值（二次值）：${document.getElementById('secondProtection').textContent}
一段定值（一次值）：${document.getElementById('firstProtectionPrimary').textContent}
二段定值（一次值）：${document.getElementById('secondProtectionPrimary').textContent}
零序定值：${document.getElementById('zeroSequence').textContent}

【定值配置建议】
${document.getElementById('textResult').innerText}

${document.getElementById('warningContainer').innerText || ''}
=====================================
变压器继保定值计算器 v6.1
开发者：hanhan`;

      // 创建并下载文件
      const blob = new Blob([results], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `变压器定值计算_${new Date().getTime()}.txt`;
      link.click();
    }

    // 键盘快捷键支持 - 兼容性增强
    if (document.addEventListener) {
      document.addEventListener('keydown', function(e) {
        e = e || window.event;
        var keyCode = e.keyCode || e.which;
        var ctrlKey = e.ctrlKey || e.metaKey;
        
        // Ctrl + Enter 计算
        if (ctrlKey && keyCode === 13) {
          calculate();
        }
        // Ctrl + R 重置
        else if (ctrlKey && (keyCode === 82 || (e.key && e.key.toLowerCase() === 'r'))) {
          if (e.preventDefault) e.preventDefault();
          resetCapacities();
        }
        // Ctrl + S 导出
        else if (ctrlKey && (keyCode === 83 || (e.key && e.key.toLowerCase() === 's'))) {
          if (e.preventDefault) e.preventDefault();
          exportResults();
        }
      });
    } else if (document.attachEvent) {
      document.attachEvent('onkeydown', function(e) {
        e = e || window.event;
        var keyCode = e.keyCode || e.which;
        var ctrlKey = e.ctrlKey;
        
        if (ctrlKey && keyCode === 13) {
          calculate();
        } else if (ctrlKey && keyCode === 82) {
          e.returnValue = false;
          resetCapacities();
        } else if (ctrlKey && keyCode === 83) {
          e.returnValue = false;
          exportResults();
        }
      });
    }

    // 点击模态框外部关闭 - 兼容性处理
    var capacityModal = document.getElementById('capacityModal');
    if (capacityModal) {
      if (capacityModal.addEventListener) {
        capacityModal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeCapacityModal();
          }
        });
      } else if (capacityModal.attachEvent) {
        capacityModal.attachEvent('onclick', function(e) {
          e = e || window.event;
          if (e.srcElement === capacityModal) {
            closeCapacityModal();
          }
        });
      }
    }

    // 移除原来的输入验证事件监听器（已在 initializeEventListeners 中处理）
  </script>
</body>
</html>